
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step 2: Manage Guests</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --font-main: 'Plus Jakarta Sans', sans-serif; }
  html[lang="ar"] { --font-main: 'Cairo', sans-serif; }
  body {
    font-family: var(--font-main);
    background-color: #0f172a; /* Dark blue-slate background */
    background-image:
      radial-gradient(at 20% 25%, hsla(212,80%,30%,0.3) 0px, transparent 50%),
      radial-gradient(at 80% 20%, hsla(280,75%,40%,0.3) 0px, transparent 50%),
      radial-gradient(at 50% 80%, hsla(320,70%,50%,0.2) 0px, transparent 50%);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
  }
  .btn-primary {
    @apply font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 ease-in-out;
    background: linear-gradient(90deg, #16A34A, #22C55E);
    box-shadow: 0 4px 15px 0 rgba(34, 197, 94, 0.5);
  }
  .btn-primary:hover:not(:disabled) {
    @apply shadow-2xl scale-105;
    box-shadow: 0 6px 20px 0 rgba(34, 197, 94, 0.65);
  }
  .btn-primary:disabled {
    background: #374151;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
    opacity: 0.6;
  }
  #previewCanvas {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
  }
</style>
</head>
<body class="text-gray-200">

<header class="bg-slate-900/50 backdrop-blur-lg border-b border-white/10 sticky top-0 z-20">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-100" data-lang-key="headerTitle">Step 2: Manage Guests & Invitations</h1>
    <div>
        <a href="index.html" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors" data-lang-key="backToHub">&larr; Back to Hub</a>
        <button id="lang-switcher" class="font-bold text-sm border border-white/20 rounded-md px-3 py-1.5 hover:bg-white/10 transition-colors ms-4">AR</button>
    </div>
  </div>
</header>

<main class="container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  
  <div class="lg:col-span-1 space-y-8">
    <div class="glass-card p-6 rounded-2xl">
      <h2 class="text-xl font-semibold text-gray-100 mb-4 border-b border-white/10 pb-3" data-lang-key="createTitle">Create Invitation</h2>
      
      <div class="mb-4">
        <label class="font-semibold text-sm text-gray-300" data-lang-key="activeDesign">Active Card Design:</label>
        <div id="template-preview-container" class="mt-2 p-3 border border-white/10 rounded-lg bg-white/5 min-h-[100px] flex items-center justify-center">
        </div>
      </div>

      <div class="mb-4">
        <label for="guestNameInput" class="font-semibold text-sm text-gray-300" data-lang-key="guestNameLabel">Guest Name:</label>
        <input type="text" id="guestNameInput" data-lang-key="guestNamePlaceholder" placeholder="Enter guest name..." class="mt-2 w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-green-500 focus:border-green-500 transition">
      </div>
      
      <div class="mt-4">
          <label class="font-semibold text-sm text-gray-300" data-lang-key="livePreview">Live Preview:</label>
          <div id="preview-container" class="mt-2 p-2 border border-white/10 rounded-lg bg-slate-900 flex items-center justify-center min-h-[200px]">
            <canvas id="previewCanvas"></canvas>
          </div>
      </div>
      
      <button id="addGuestButton" class="mt-6 w-full btn-primary flex items-center justify-center gap-2 py-2.5" disabled>
        <span id="btn-text" data-lang-key="addGuestBtn">Add Guest & Generate Link</span>
        <div id="btn-spinner" class="hidden h-5 w-5 animate-spin rounded-full border-2 border-solid border-white border-r-transparent" role="status"></div>
      </button>
    </div>
  </div>

  <div class="lg:col-span-2 glass-card p-6 rounded-2xl">
     <h2 class="text-xl font-semibold text-gray-100 mb-4 border-b border-white/10 pb-3" data-lang-key="guestListTitle">Guest List</h2>
     <div id="output" class="text-center text-gray-400">
        <p data-lang-key="loadingGuests">Loading guest list...</p>
     </div>
  </div>
</main>

<div id="notification" class="fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-[120%] transition-transform duration-500 ease-in-out"></div>
<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref as databaseRef, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm';

const firebaseConfig = { apiKey: "AIzaSyCuZVUBIA0oDQuPzRUQbMJCJZK32zmVaVQ", authDomain: "final-draft-8f39d.firebaseapp.com", databaseURL: "https://final-draft-8f39d-default-rtdb.firebaseio.com", projectId: "final-draft-8f39d", storageBucket: "final-draft-8f39d.appspot.com", messagingSenderId: "994437210054", appId: "1:994437210054:web:628c741b81ccf741175cc7" };

const translations = {
    en: {
        headerTitle: "Step 2: Manage Guests & Invitations",
        backToHub: "← Back to Hub",
        createTitle: "Create Invitation",
        activeDesign: "Active Card Design:",
        designLoaded: "Design loaded successfully.",
        noDesign: "No card design found. Please",
        createDesignLink: "create a card design",
        noDesignSuffix: "first.",
        guestNameLabel: "Guest Name:",
        guestNamePlaceholder: "Enter guest name...",
        livePreview: "Live Preview:",
        addGuestBtn: "Add Guest & Generate Link",
        generating: "Generating...",
        guestListTitle: "Guest List",
        loadingGuests: "Loading guest list...",
        noGuests: "No guests found. Start by generating invitations!",
        tableHeaderName: "Name",
        tableHeaderRSVP: "RSVP",
        tableHeaderActions: "Actions",
        rsvpYes: "Yes",
        rsvpNo: "No",
        rsvpNA: "N/A",
        viewCard: "View Card",
        share: "Share",
        shareMessage: "You are cordially invited. Please view your personalized invitation here: ",
        creationSuccess: "Invitation created for ",
        creationError: "Failed to create invitation: ",
        missingInfoError: "Cannot generate: missing template or guest name.",
    },
    ar: {
        headerTitle: "الخطوة ٢: إدارة الضيوف والدعوات",
        backToHub: "→ العودة للمركز",
        createTitle: "إنشاء دعوة",
        activeDesign: "تصميم البطاقة النشط:",
        designLoaded: "تم تحميل التصميم بنجاح.",
        noDesign: "لم يتم العثور على تصميم بطاقة. الرجاء",
        createDesignLink: "إنشاء تصميم بطاقة",
        noDesignSuffix: "أولاً.",
        guestNameLabel: "اسم الضيف:",
        guestNamePlaceholder: "أدخل اسم الضيف...",
        livePreview: "معاينة حية:",
        addGuestBtn: "إضافة ضيف وإنشاء رابط",
        generating: "جاري الإنشاء...",
        guestListTitle: "قائمة الضيوف",
        loadingGuests: "جاري تحميل قائمة الضيوف...",
        noGuests: "لا يوجد ضيوف. ابدأ بإنشاء بعض الدعوات!",
        tableHeaderName: "الاسم",
        tableHeaderRSVP: "تأكيد الحضور",
        tableHeaderActions: "الإجراءات",
        rsvpYes: "نعم",
        rsvpNo: "لا",
        rsvpNA: "غير محدد",
        viewCard: "عرض البطاقة",
        share: "مشاركة",
        shareMessage: "أنت مدعو بكل سرور. يرجى الاطلاع على دعوتك الشخصية هنا: ",
        creationSuccess: "تم إنشاء دعوة لـ ",
        creationError: "فشل إنشاء الدعوة: ",
        missingInfoError: "لا يمكن الإنشاء: تصميم أو اسم ضيف مفقود.",
    }
};

let currentLang = localStorage.getItem('language') || 'en';
const setLanguage = (lang) => {
    localStorage.setItem('language', lang);
    currentLang = lang;
    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    document.getElementById('lang-switcher').textContent = lang === 'ar' ? 'EN' : 'AR';
    document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.getAttribute('data-lang-key');
        if (translations[lang][key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = translations[lang][key];
            } else {
                el.textContent = translations[lang][key];
            }
        }
    });
    document.title = translations[lang].headerTitle;
    readData(); // Refresh table with new language
};

document.getElementById('lang-switcher').addEventListener('click', () => {
    const newLang = currentLang === 'en' ? 'ar' : 'en';
    setLanguage(newLang);
});

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

const addGuestButton = document.getElementById('addGuestButton');
const guestNameInput = document.getElementById('guestNameInput');
const templatePreviewContainer = document.getElementById('template-preview-container');
const btnText = document.getElementById('btn-text');
const btnSpinner = document.getElementById('btn-spinner');
const previewCanvas = document.getElementById('previewCanvas');

let cardTemplate = null;
const IMGBB_API_KEY = '97c60166127ae9258012f463e09b1e2d';
let previewQrDataUrl = null;

function initializePage() {
    try {
        const savedTemplate = localStorage.getItem('cardTemplate');
        if (savedTemplate) {
            cardTemplate = JSON.parse(savedTemplate);
            templatePreviewContainer.innerHTML = `<div class="flex items-center gap-4">
                    <img src="${cardTemplate.imageUrl}" class="w-20 h-auto rounded-md border border-white/10" alt="Template Preview">
                    <p class="text-sm text-gray-300">${translations[currentLang].designLoaded}</p>
                </div>`;
            guestNameInput.disabled = false;
        } else {
            throw new Error('No template found');
        }
    } catch (e) {
        templatePreviewContainer.innerHTML = `<p class="text-sm text-red-400 text-center">
            ${translations[currentLang].noDesign} <a href="editor.html" class="font-bold underline hover:text-red-300">${translations[currentLang].createDesignLink}</a> ${translations[currentLang].noDesignSuffix}
        </p>`;
        guestNameInput.disabled = true;
        addGuestButton.disabled = true;
    }
    setLanguage(currentLang);
}

async function previewCard(name) {
    if (!cardTemplate) return;
    const ctx = previewCanvas.getContext('2d');
    if (!name || name.trim() === '') {
        addGuestButton.disabled = true;
        ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        return;
    }
    addGuestButton.disabled = false;
    if (!previewQrDataUrl) {
        previewQrDataUrl = await QRCode.toDataURL('PREVIEW-QR', { width: 400, margin: 1, color: { dark: '#000000', light: '#FFFFFF' } });
    }
    const bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    bgImg.onload = () => {
        const aspectRatio = bgImg.width / bgImg.height;
        const containerWidth = document.getElementById('preview-container').offsetWidth - 8;
        previewCanvas.width = containerWidth;
        previewCanvas.height = containerWidth / aspectRatio;
        ctx.drawImage(bgImg, 0, 0, previewCanvas.width, previewCanvas.height);
        const nameSettings = cardTemplate.nameSettings;
        ctx.fillStyle = nameSettings.color;
        ctx.font = `${nameSettings.fontSize * previewCanvas.height}px ${nameSettings.fontFamily}`;
        ctx.textBaseline = 'top';
        ctx.fillText(name, nameSettings.x * previewCanvas.width, nameSettings.y * previewCanvas.height);
        const qrSettings = cardTemplate.qrSettings;
        const qrImg = new Image();
        qrImg.onload = () => {
            ctx.drawImage(qrImg, qrSettings.x * previewCanvas.width, qrSettings.y * previewCanvas.height, qrSettings.size * previewCanvas.width, qrSettings.size * previewCanvas.width);
        };
        qrImg.src = previewQrDataUrl;
    };
    bgImg.src = cardTemplate.imageUrl;
}

guestNameInput.addEventListener('input', () => previewCard(guestNameInput.value));
document.addEventListener('DOMContentLoaded', initializePage);

addGuestButton.addEventListener('click', async () => {
    const guestName = guestNameInput.value.trim();
    if (!cardTemplate || !guestName) {
        showNotification(translations[currentLang].missingInfoError, 'red');
        return;
    }
    addGuestButton.disabled = true;
    btnText.textContent = translations[currentLang].generating;
    btnSpinner.classList.remove('hidden');
    try {
        await generateAndUploadCardForGuest(guestName, cardTemplate);
        showNotification(`${translations[currentLang].creationSuccess}${guestName}!`, 'green');
        guestNameInput.value = '';
        const ctx = previewCanvas.getContext('2d');
        ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        document.getElementById('successSound').play().catch(e => console.log("Sound play failed:", e));
    } catch (error) {
        console.error("Failed to create invitation:", error);
        showNotification(`${translations[currentLang].creationError}${error.message}`, 'red');
    } finally {
        btnText.textContent = translations[currentLang].addGuestBtn;
        btnSpinner.classList.add('hidden');
        addGuestButton.disabled = true;
    }
});

async function generateAndUploadCardForGuest(guestName, template) {
    const newNodeRef = push(databaseRef(database));
    const newNodeKey = newNodeRef.key;
    const randomNumber = Math.random().toString(36).substring(2, 10).toUpperCase();
    const qrDataURL = await QRCode.toDataURL(randomNumber, { width: 400, margin: 1, color: { dark: '#000000', light: '#FFFFFF' } });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    await new Promise((resolve, reject) => { bgImg.onload = resolve; bgImg.onerror = reject; bgImg.src = template.imageUrl; });
    canvas.width = bgImg.width;
    canvas.height = bgImg.height;
    ctx.drawImage(bgImg, 0, 0);
    const nameSettings = template.nameSettings;
    ctx.fillStyle = nameSettings.color;
    ctx.font = `${nameSettings.fontSize * canvas.height}px ${nameSettings.fontFamily}`;
    ctx.textBaseline = 'top';
    ctx.fillText(guestName, nameSettings.x * canvas.width, nameSettings.y * canvas.height);
    const qrSettings = template.qrSettings;
    const qrImg = new Image();
    await new Promise((resolve, reject) => { qrImg.onload = resolve; qrImg.onerror = reject; qrImg.src = qrDataURL; });
    ctx.drawImage(qrImg, qrSettings.x * canvas.width, qrSettings.y * canvas.height, qrSettings.size * canvas.width, qrSettings.size * canvas.width);
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
    const formData = new FormData();
    formData.append('image', blob);
    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
    const result = await response.json();
    if (!result.success) throw new Error(result.error?.message || 'ImgBB upload failed');
    const personalizedImageUrl = result.data.url;
    const invitePath = window.location.pathname.replace('manager.html', 'invite.html');
    const inviteLink = `${window.location.origin}${invitePath}?id=${newNodeKey}&img=${encodeURIComponent(personalizedImageUrl)}`;
    return set(newNodeRef, { 'الإسم': guestName.trim(), 'رقم_عشوائي': randomNumber, 'scanned': false, 'link': inviteLink });
}

function readData() {
    onValue(databaseRef(database), snapshot => {
        const data = snapshot.val();
        const outputDiv = document.getElementById('output');
        if (!data || typeof data !== 'object') {
            outputDiv.innerHTML = `<p class="text-center text-gray-400">${translations[currentLang].noGuests}</p>`;
            return;
        }
        const parentNodes = Object.keys(data).sort().reverse();
        let tableHTML = `<div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-white/5"><tr>
                        <th class="py-3 px-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">${translations[currentLang].tableHeaderName}</th>
                        <th class="py-3 px-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">${translations[currentLang].tableHeaderRSVP}</th>
                        <th class="py-3 px-4 text-left text-xs font-bold uppercase tracking-wider text-gray-400">${translations[currentLang].tableHeaderActions}</th></tr></thead>
                        <tbody class="text-gray-300">`;
        parentNodes.forEach((parentNode) => {
            const nodeData = data[parentNode];
            const rsvpRaw = nodeData['حضور'];
            const rsvp = rsvpRaw === 'نعم' ? translations[currentLang].rsvpYes : rsvpRaw === 'لا' ? translations[currentLang].rsvpNo : translations[currentLang].rsvpNA;
            let rsvpClass = 'text-gray-400';
            if (rsvpRaw === 'نعم') rsvpClass = 'text-green-400';
            if (rsvpRaw === 'لا') rsvpClass = 'text-red-400';
            const shareMessage = encodeURIComponent(`${translations[currentLang].shareMessage}${nodeData.link}`);
            const whatsappLink = `https://wa.me/?text=${shareMessage}`;
            tableHTML += `<tr id="row-${parentNode}" class="border-b border-white/10 hover:bg-white/5 transition-colors">
                    <td class="py-4 px-4 font-semibold text-white">${nodeData['الإسم'] || ''}</td>
                    <td class="py-4 px-4 font-bold ${rsvpClass}">${rsvp}</td>
                    <td class="py-4 px-4">
                        <div class="flex items-center gap-x-6">
                            ${nodeData.link ? `<a href="${nodeData.link}" target="_blank" class="text-indigo-400 hover:text-indigo-300 text-sm font-semibold transition-colors">${translations[currentLang].viewCard}</a>` : ''}
                            ${nodeData.link ? `<a href="${whatsappLink}" target="_blank" class="text-green-400 hover:text-green-300 text-sm font-semibold transition-colors">${translations[currentLang].share}</a>` : ''}
                        </div>
                    </td>
                </tr>`;
        });
        tableHTML += `</tbody></table></div>`;
        outputDiv.innerHTML = tableHTML;
    });
}

function showNotification(message, type = 'green') {
    const notification = document.getElementById('notification');
    const colors = { green: 'bg-green-500', red: 'bg-red-500', yellow: 'bg-yellow-500' };
    notification.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transition-transform duration-500 ease-in-out ${colors[type] || 'bg-gray-500'} transform translate-x-[120%]`;
    notification.textContent = message;
    notification.style.transform = document.documentElement.dir === 'rtl' ? 'translateX(-120%)' : 'translateX(0)';
    setTimeout(() => {
        notification.style.transform = document.documentElement.dir === 'rtl' ? 'translateX(0)' : 'translateX(120%)';
    }, 4000);
}

</script>
</body>
</html>
