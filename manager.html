
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step 2: Manage Guests</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Cairo:wght@400;700&family=Roboto:wght@400;700;900&family=Amiri:wght@700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
  :root { --font-main: 'Plus Jakarta Sans', sans-serif; }
  html[lang="ar"] { --font-main: 'Cairo', sans-serif; }
  body {
    font-family: var(--font-main);
    background-color: #0f172a;
    background-image:
      radial-gradient(at 20% 25%, hsla(212,80%,30%,0.3) 0px, transparent 50%),
      radial-gradient(at 80% 20%, hsla(280,75%,40%,0.3) 0px, transparent 50%),
      radial-gradient(at 50% 80%, hsla(320,70%,50%,0.2) 0px, transparent 50%);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
  }
  .btn-primary {
    @apply font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 ease-in-out;
    background: linear-gradient(90deg, #6366F1, #8B5CF6);
    box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.5);
  }
  .btn-primary:hover:not(:disabled) {
    @apply shadow-2xl scale-105;
    box-shadow: 0 6px 20px 0 rgba(116, 79, 168, 0.65);
  }
  .btn-primary:disabled { background: #374151; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.6; }
  #previewCanvas { max-width: 100%; height: auto; border-radius: 8px; }
  .side-btn.active {
    background-color: #4f46e5; /* indigo-600 */
    color: #ffffff;
    outline: 2px solid #6366f1; /* indigo-500 */
    outline-offset: 2px;
  }
  .guest-tab.active { @apply border-indigo-400 text-indigo-300; }
</style>
</head>
<body class="text-gray-200" style="display: none;">

<header class="bg-slate-900/50 backdrop-blur-lg border-b border-white/10 sticky top-0 z-20">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-100" data-lang-key="headerTitle">Step 2: Manage Guests & Invitations</h1>
    <div class="flex items-center gap-4">
        <a href="index.html" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors" data-lang-key="backToHub">&larr; Back to Hub</a>
        <button id="lang-switcher" class="font-bold text-sm border border-white/20 rounded-md px-3 py-1.5 hover:bg-white/10 transition-colors">AR</button>
        <button id="logout-button" class="font-bold text-sm bg-red-600/50 border border-red-500/30 text-red-300 rounded-md px-3 py-1.5 hover:bg-red-600/70 transition-colors" data-lang-key="logout">Logout</button>
    </div>
  </div>
</header>

<main class="container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
  <div class="lg:col-span-1 space-y-8">
    <div class="glass-card p-6 rounded-2xl">
      <h2 class="text-xl font-semibold text-gray-100 mb-4 border-b border-white/10 pb-3" data-lang-key="createTitle">Create Invitation</h2>
      <div class="mb-4">
        <label class="font-semibold text-sm text-gray-300" data-lang-key="invitationSide">Invitation For:</label>
        <div id="side-selector" class="mt-2 flex rounded-lg bg-slate-800 border border-slate-600 p-1">
            <button data-side="groom" class="side-btn flex-1 p-2 rounded-md text-sm font-semibold transition-colors" data-lang-key="groomSide">Groom's Side</button>
            <button data-side="bride" class="side-btn flex-1 p-2 rounded-md text-sm font-semibold transition-colors" data-lang-key="brideSide">Bride's Side</button>
        </div>
      </div>
      <div class="mb-4">
        <label class="font-semibold text-sm text-gray-300" data-lang-key="activeDesign">Active Card Design:</label>
        <div id="template-preview-container" class="mt-2 p-3 border border-white/10 rounded-lg bg-white/5 min-h-[100px] flex items-center justify-center"></div>
      </div>
      <div class="mb-4">
        <label for="guestNameInput" class="font-semibold text-sm text-gray-300" data-lang-key="guestNameLabel">Guest Name:</label>
        <input type="text" id="guestNameInput" data-lang-key="guestNamePlaceholder" placeholder="Enter guest name..." class="mt-2 w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
      </div>
       <div class="mb-4">
        <label for="guestCompanionsInput" class="font-semibold text-sm text-gray-300" data-lang-key="companionsLabel">Number of Companions:</label>
        <input type="number" id="guestCompanionsInput" value="0" min="0" max="10" class="mt-2 w-full p-3 bg-slate-800 border border-slate-600 rounded-lg text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
      </div>
      <div class="mt-4">
          <label class="font-semibold text-sm text-gray-300" data-lang-key="livePreview">Live Preview:</label>
          <div id="preview-container" class="mt-2 p-2 border border-white/10 rounded-lg bg-slate-900 flex items-center justify-center min-h-[200px]">
            <canvas id="previewCanvas"></canvas>
          </div>
      </div>
      <button id="addGuestButton" class="mt-6 w-full btn-primary flex items-center justify-center gap-2 py-2.5" disabled>
        <span id="btn-text" data-lang-key="addGuestBtn">Add Guest & Generate Link</span>
        <div id="btn-spinner" class="hidden h-5 w-5 animate-spin rounded-full border-2 border-solid border-white border-r-transparent" role="status"></div>
      </button>
    </div>
  </div>
  <div class="lg:col-span-2 glass-card p-6 rounded-2xl">
      <div class="mb-6 border-b border-white/10 pb-4">
        <h3 class="text-lg font-semibold text-gray-100 mb-4" data-lang-key="summaryTitle">Attendance Summary</h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
            <div class="bg-blue-500/10 p-4 rounded-lg">
                <p class="text-sm font-medium text-blue-300" data-lang-key="groomSide">Groom's Side</p>
                <h4 id="groom-count" class="text-3xl font-bold text-white mt-1">0</h4>
            </div>
            <div class="bg-pink-500/10 p-4 rounded-lg">
                <p class="text-sm font-medium text-pink-300" data-lang-key="brideSide">Bride's Side</p>
                <h4 id="bride-count" class="text-3xl font-bold text-white mt-1">0</h4>
            </div>
            <div class="bg-indigo-500/10 p-4 rounded-lg">
                <p class="text-sm font-medium text-indigo-300" data-lang-key="totalConfirmed">Total Confirmed</p>
                <h4 id="total-count" class="text-3xl font-bold text-white mt-1">0</h4>
            </div>
        </div>
      </div>
     <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-100" data-lang-key="guestListTitle">Guest List</h2>
        <div id="guest-list-tabs" class="flex border-b-2 border-slate-700 mt-4 sm:mt-0">
            <button data-tab="all" class="guest-tab px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors" data-lang-key="tabAll">All</button>
            <button data-tab="groom" class="guest-tab px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors" data-lang-key="tabGroom">Groom</button>
            <button data-tab="bride" class="guest-tab px-4 py-2 text-sm font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors" data-lang-key="tabBride">Bride</button>
        </div>
     </div>
     <div id="output" class="text-center text-gray-400">
        <p data-lang-key="loadingGuests">Loading guest list...</p>
     </div>
  </div>
</main>
<div id="notification" class="fixed top-5 z-50 text-white py-3 px-6 rounded-lg shadow-xl transform transition-transform duration-500 ease-in-out"></div>

<div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="glass-card p-6 rounded-2xl max-w-sm w-full text-center">
    <h3 class="text-lg font-bold text-gray-100 mb-2" data-lang-key="deleteConfirmTitle">Confirm Deletion</h3>
    <p class="text-gray-400 mb-6" data-lang-key="deleteConfirm">Are you sure you want to delete this guest? This action cannot be undone.</p>
    <div class="flex justify-center gap-4">
      <button id="cancel-delete-btn" class="font-bold py-2 px-6 rounded-lg bg-slate-600 hover:bg-slate-500 transition-colors" data-lang-key="cancelBtn">Cancel</button>
      <button id="confirm-delete-btn" class="font-bold py-2 px-6 rounded-lg bg-red-600 hover:bg-red-500 transition-colors" data-lang-key="delete">Delete</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref as databaseRef, onValue, push, set, get, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm';

const firebaseConfig = { apiKey: "AIzaSyCuZVUBIA0oDQuPzRUQbMJCJZK32zmVaVQ", authDomain: "final-draft-8f39d.firebaseapp.com", databaseURL: "https://final-draft-8f39d-default-rtdb.firebaseio.com", projectId: "final-draft-8f39d", storageBucket: "final-draft-8f39d.appspot.com", messagingSenderId: "994437210054", appId: "1:994437210054:web:628c741b81ccf741175cc7" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);
let currentUser = null;

onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        document.body.style.display = 'block';
        initializePage();
    } else {
        window.location.href = 'login.html';
    }
});

document.getElementById('logout-button').addEventListener('click', () => {
    signOut(auth);
});

const translations = {
    en: { headerTitle: "Step 2: Manage Guests & Invitations", backToHub: "← Back to Hub", createTitle: "Create Invitation", invitationSide: "Invitation For:", groomSide: "Groom's Side", brideSide: "Bride's Side", activeDesign: "Active Card Design:", designLoaded: "Design loaded successfully.", noDesign: "No card design found for this side. Please", createDesignLink: "create a card design", noDesignSuffix: "first.", guestNameLabel: "Guest Name:", guestNamePlaceholder: "Enter guest name...", companionsLabel: "Number of Companions:", livePreview: "Live Preview:", addGuestBtn: "Add Guest & Generate Link", generating: "Generating...", summaryTitle: "Attendance Summary", totalConfirmed: "Total Confirmed", guestListTitle: "Guest List", tabAll: "All", tabGroom: "Groom", tabBride: "Bride", loadingGuests: "Loading guest list...", noGuests: "No guests found. Start by generating invitations!", tableHeaderName: "Name", tableHeaderSide: "Side", tableHeaderRSVP: "RSVP", tableHeaderActions: "Actions", rsvpYes: "Yes", rsvpNo: "No", rsvpNA: "N/A", viewCard: "View", share: "Share", delete: "Delete", deleteConfirmTitle: "Confirm Deletion", deleteConfirm: "Are you sure you want to delete this guest? This action cannot be undone.", cancelBtn: "Cancel", deleteSuccess: "Guest deleted successfully.", deleteError: "Error deleting guest: ", shareMessage: "You are cordially invited. Please view your personalized invitation here: ", creationSuccess: "Invitation created for ", creationError: "Failed to create invitation: ", missingInfoError: "Cannot generate: missing template or guest name.", logout: "Logout" },
    ar: { headerTitle: "الخطوة ٢: إدارة الضيوف والدعوات", backToHub: "→ العودة للمركز", createTitle: "إنشاء دعوة", invitationSide: "الدعوة لجانب:", groomSide: "جانب العريس", brideSide: "جانب العروس", activeDesign: "تصميم البطاقة النشط:", designLoaded: "تم تحميل التصميم بنجاح.", noDesign: "لم يتم العثور على تصميم بطاقة لهذا الجانب. الرجاء", createDesignLink: "إنشاء تصميم بطاقة", noDesignSuffix: "أولاً.", guestNameLabel: "اسم الضيف:", guestNamePlaceholder: "أدخل اسم الضيف...", companionsLabel: "عدد المرافقين:", livePreview: "معاينة حية:", addGuestBtn: "إضافة ضيف وإنشاء رابط", generating: "جاري الإنشاء...", summaryTitle: "ملخص الحضور", totalConfirmed: "إجمالي المؤكدين", guestListTitle: "قائمة الضيوف", tabAll: "الكل", tabGroom: "العريس", tabBride: "العروس", loadingGuests: "جاري تحميل قائمة الضيوف...", noGuests: "لا يوجد ضيوف. ابدأ بإنشاء بعض الدعوات!", tableHeaderName: "الاسم", tableHeaderSide: "الجانب", tableHeaderRSVP: "تأكيد الحضور", tableHeaderActions: "الإجراءات", rsvpYes: "نعم", rsvpNo: "لا", rsvpNA: "غير محدد", viewCard: "عرض", share: "مشاركة", delete: "حذف", deleteConfirmTitle: "تأكيد الحذف", deleteConfirm: "هل أنت متأكد من رغبتك في حذف هذا الضيف؟ لا يمكن التراجع عن هذا الإجراء.", cancelBtn: "إلغاء", deleteSuccess: "تم حذف الضيف بنجاح.", deleteError: "خطأ أثناء حذف الضيف: ", shareMessage: "أنت مدعو بكل سرور. يرجى الاطلاع على دعوتك الشخصية هنا: ", creationSuccess: "تم إنشاء دعوة لـ ", creationError: "فشل إنشاء الدعوة: ", missingInfoError: "لا يمكن الإنشاء: تصميم أو اسم ضيف مفقود.", logout: "تسجيل الخروج" }
};
let currentLang = localStorage.getItem('language') || 'en';
const setLanguage = (lang) => { localStorage.setItem('language', lang); currentLang = lang; document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; document.getElementById('lang-switcher').textContent = lang === 'ar' ? 'EN' : 'AR'; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (translations[lang][key]) { if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.placeholder = translations[lang][key]; else el.textContent = translations[lang][key]; } }); document.title = translations[lang].headerTitle; readData(); };
document.getElementById('lang-switcher').addEventListener('click', () => setLanguage(currentLang === 'en' ? 'ar' : 'en'));

const addGuestButton = document.getElementById('addGuestButton');
const guestNameInput = document.getElementById('guestNameInput');
const guestCompanionsInput = document.getElementById('guestCompanionsInput');
const templatePreviewContainer = document.getElementById('template-preview-container');
const btnText = document.getElementById('btn-text');
const btnSpinner = document.getElementById('btn-spinner');
const previewCanvas = document.getElementById('previewCanvas');
const IMGBB_API_KEY = '97c60166127ae9258012f463e09b1e2d';

let groomCardTemplate = null;
let brideCardTemplate = null;
let activeCardTemplate = null;
let currentSide = localStorage.getItem('managerCurrentSide') || 'groom';
let currentGuestTab = 'all';
let allGuests = {};

const loadImage = (src) => new Promise((resolve, reject) => { const img = new Image(); img.crossOrigin = "anonymous"; img.onload = () => resolve(img); img.onerror = reject; img.src = src; });

async function renderCard(canvas, guestName, template, qrCodeValue, allowedGuests) {
    const ctx = canvas.getContext('2d');
    const bgImg = await loadImage(template.imageUrl);
    canvas.width = bgImg.width;
    canvas.height = bgImg.height;
    ctx.drawImage(bgImg, 0, 0);

    const ns = template.nameSettings;
    ctx.save();
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = ns.color;
    const fontStyle = ns.italic ? 'italic' : 'normal';
    const fontWeight = ns.bold ? 'bold' : 'normal';
    ctx.font = `${fontStyle} ${fontWeight} ${ns.fontSize * canvas.height}px ${ns.family}`;
    if (ns.shadow.enabled) {
        ctx.shadowColor = ns.shadow.color;
        ctx.shadowBlur = ns.shadow.blur;
        ctx.shadowOffsetX = ns.shadow.x;
        ctx.shadowOffsetY = ns.shadow.y;
    }
    const nameX = ns.x * canvas.width;
    const nameY = ns.y * canvas.height;
    ctx.translate(nameX, nameY);
    ctx.rotate(ns.rotation * Math.PI / 180);
    if (ns.stroke.enabled) {
        ctx.strokeStyle = ns.stroke.color;
        ctx.lineWidth = ns.stroke.width;
        ctx.strokeText(guestName, 0, 0);
    }
    ctx.fillText(guestName, 0, 0);
    ctx.restore();

    const qs = template.qrSettings;
    const qrDataURL = await QRCode.toDataURL(qrCodeValue, { width: 400, margin: 1, errorCorrectionLevel: 'H', color: { dark: qs.colorDark, light: qs.colorLight } });
    const qrImg = await loadImage(qrDataURL);
    const qrSize = qs.size * canvas.width;
    const qrX = qs.x * canvas.width - qrSize / 2;
    const qrY = qs.y * canvas.height - qrSize / 2;
    ctx.drawImage(qrImg, qrX, qrY, qrSize, qrSize);
    
    if (qs.logoUrl) {
        const logoImg = await loadImage(qs.logoUrl);
        const logoSize = qrSize * 0.3; 
        const logoX = qrX + (qrSize - logoSize) / 2;
        const logoY = qrY + (qrSize - logoSize) / 2;
        ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
    }
    
    if (qs.showPartySize && allowedGuests > 0) {
        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const displayX = qs.x * canvas.width;
        const displayY = qs.y * canvas.height;
        const fontSize = (qs.size * canvas.width) * 0.25;

        const numberText = allowedGuests.toString();
        const iconText = 'groups';

        ctx.font = `bold ${fontSize}px 'Roboto', sans-serif`;
        const numberWidth = ctx.measureText(numberText).width;
        ctx.font = `${fontSize}px 'Material Symbols Outlined'`;
        const iconWidth = ctx.measureText(iconText).width;
        
        const gap = fontSize * 0.15;
        const totalWidth = iconWidth + gap + numberWidth;

        const iconX = displayX - (totalWidth / 2) + (iconWidth / 2);
        const numberX = iconX + (iconWidth / 2) + gap + (numberWidth / 2);

        ctx.fillStyle = 'white';
        ctx.strokeStyle = 'rgba(0,0,0,0.8)';
        ctx.lineWidth = fontSize / 12;

        ctx.font = `${fontSize}px 'Material Symbols Outlined'`;
        ctx.strokeText(iconText, iconX, displayY);
        ctx.fillText(iconText, iconX, displayY);

        ctx.font = `bold ${fontSize}px 'Roboto', sans-serif`;
        ctx.strokeText(numberText, numberX, displayY);
        ctx.fillText(numberText, numberX, displayY);
        
        ctx.restore();
    }
}

async function previewCard(name) {
    if (!activeCardTemplate || !name || name.trim() === '') {
        addGuestButton.disabled = true;
        const ctx = previewCanvas.getContext('2d');
        ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
        return;
    }
    addGuestButton.disabled = false;
    const previewContainer = document.getElementById('preview-container');
    const tempCanvas = document.createElement('canvas');
    const allowedGuests = 1 + (parseInt(guestCompanionsInput.value, 10) || 0);
    await renderCard(tempCanvas, name, activeCardTemplate, 'PREVIEW-QR', allowedGuests);
    
    const aspectRatio = tempCanvas.width / tempCanvas.height;
    const containerWidth = previewContainer.offsetWidth - 8;
    previewCanvas.width = containerWidth;
    previewCanvas.height = containerWidth / aspectRatio;
    const previewCtx = previewCanvas.getContext('2d');
    previewCtx.drawImage(tempCanvas, 0, 0, previewCanvas.width, previewCanvas.height);
}

function updateActiveDesign() {
    activeCardTemplate = currentSide === 'groom' ? groomCardTemplate : brideCardTemplate;
    if (activeCardTemplate) {
        templatePreviewContainer.innerHTML = `<div class="flex items-center gap-4"><img src="${activeCardTemplate.imageUrl}" class="w-20 h-auto rounded-md border border-white/10" alt="Template Preview"><p class="text-sm text-gray-300">${translations[currentLang].designLoaded}</p></div>`;
        guestNameInput.disabled = false;
    } else {
        templatePreviewContainer.innerHTML = `<p class="text-sm text-red-400 text-center">${translations[currentLang].noDesign} <a href="editor.html?side=${currentSide}" class="font-bold underline hover:text-red-300">${translations[currentLang].createDesignLink}</a> ${translations[currentLang].noDesignSuffix}</p>`;
        guestNameInput.disabled = true;
        addGuestButton.disabled = true;
    }
    previewCard(guestNameInput.value);
}

async function initializePage() {
    if (!currentUser) return;
    const groomRef = databaseRef(database, `cardTemplates/${currentUser.uid}/groom`);
    const brideRef = databaseRef(database, `cardTemplates/${currentUser.uid}/bride`);
    
    const groomSnap = await get(groomRef);
    if (groomSnap.exists()) groomCardTemplate = groomSnap.val();

    const brideSnap = await get(brideRef);
    if (brideSnap.exists()) brideCardTemplate = brideSnap.val();

    document.querySelector(`.side-btn[data-side="${currentSide}"]`).classList.add('active');
    document.querySelector(`.guest-tab[data-tab="${currentGuestTab}"]`).classList.add('active');
    
    updateActiveDesign();
    setLanguage(currentLang);
}
guestNameInput.addEventListener('input', () => previewCard(guestNameInput.value));
guestCompanionsInput.addEventListener('input', () => previewCard(guestNameInput.value));
document.addEventListener('DOMContentLoaded', () => setLanguage(currentLang));

addGuestButton.addEventListener('click', async () => {
    const guestName = guestNameInput.value.trim();
    if (!activeCardTemplate || !guestName) { showNotification(translations[currentLang].missingInfoError, 'red'); return; }
    addGuestButton.disabled = true;
    btnText.textContent = translations[currentLang].generating;
    btnSpinner.classList.remove('hidden');
    try {
        await generateAndUploadCardForGuest(guestName, activeCardTemplate);
        showNotification(`${translations[currentLang].creationSuccess}${guestName}!`, 'green');
        guestNameInput.value = '';
        guestCompanionsInput.value = 0;
        previewCard(''); // Clear preview
    } catch (error) { console.error("Failed to create invitation:", error); showNotification(`${translations[currentLang].creationError}${error.message}`, 'red'); } finally { btnText.textContent = translations[currentLang].addGuestBtn; btnSpinner.classList.add('hidden'); addGuestButton.disabled = true; }
});

function generateShortId(length = 7) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

async function generateAndUploadCardForGuest(guestName, template) {
    if(!currentUser) throw new Error("User not logged in.");
    const companionsAllowed = parseInt(guestCompanionsInput.value, 10) || 0;
    const allowedGuests = 1 + companionsAllowed;

    const guestListRef = databaseRef(database, `guests/${currentUser.uid}/${currentSide}`);
    const newNodeRef = push(guestListRef);
    const newNodeKey = newNodeRef.key;
    const randomNumber = Math.random().toString(36).substring(2, 10).toUpperCase();
    
    const canvas = document.createElement('canvas');
    await renderCard(canvas, guestName, template, randomNumber, allowedGuests);
    
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    const formData = new FormData();
    formData.append('image', blob);
    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
    const result = await response.json();
    if (!result.success) throw new Error(result.error?.message || 'ImgBB upload failed');
    const personalizedImageUrl = result.data.url;
    
    const fullGuestPath = `guests/${currentUser.uid}/${currentSide}/${newNodeKey}`;

    let shortId;
    let isUnique = false;
    while (!isUnique) {
        shortId = generateShortId();
        const shortLinkRef = databaseRef(database, `shortlinks/${shortId}`);
        const snapshot = await get(shortLinkRef);
        if (!snapshot.exists()) {
            isUnique = true;
        }
    }

    await set(databaseRef(database, `shortlinks/${shortId}`), fullGuestPath);

    const inviteLink = `${window.location.origin}/invite.html?s=${shortId}`;
    
    return set(newNodeRef, { 
        'الإسم': guestName.trim(), 
        'رقم_عشوائي': randomNumber, 
        'scanned': false, 
        'link': inviteLink, 
        'imageUrl': personalizedImageUrl,
        'companionsAllowed': companionsAllowed 
    });
}

function renderGuestList() {
    const outputDiv = document.getElementById('output');
    let guestsToRender = [];
    if (currentGuestTab === 'all') {
        guestsToRender = [...(allGuests.groom || []), ...(allGuests.bride || [])];
    } else {
        guestsToRender = allGuests[currentGuestTab] || [];
    }

    if (guestsToRender.length === 0) {
        outputDiv.innerHTML = `<p class="text-center text-gray-400">${translations[currentLang].noGuests}</p>`;
        return;
    }
    
    let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-white/5"><tr>
        <th class="py-2 px-2 text-left font-bold uppercase tracking-wider text-gray-400">${translations[currentLang].tableHeaderName}</th>
        <th class="py-2 px-2 text-left font-bold uppercase tracking-wider text-gray-400">${translations[currentLang].tableHeaderSide}</th>
        <th class="py-2 px-2 text-left font-bold uppercase tracking-wider text-gray-400">${translations[currentLang].tableHeaderRSVP}</th>
        <th class="py-2 px-2 text-left font-bold uppercase tracking-wider text-gray-400">${translations[currentLang].tableHeaderActions}</th>
    </tr></thead><tbody class="text-gray-300">`;

    guestsToRender.sort((a, b) => (a.data['الإسم'] || '').localeCompare(b.data['الإسم'] || '')).forEach(({ key, data, side }) => {
        const rsvpRaw = data['حضور'];
        const rsvp = rsvpRaw === 'نعم' ? translations[currentLang].rsvpYes : rsvpRaw === 'لا' ? translations[currentLang].rsvpNo : translations[currentLang].rsvpNA;
        let rsvpClass = 'text-gray-400';
        if (rsvpRaw === 'نعم') rsvpClass = 'text-emerald-400';
        if (rsvpRaw === 'لا') rsvpClass = 'text-rose-400';
        
        const sideText = side === 'groom' ? translations[currentLang].groomSide : translations[currentLang].brideSide;
        const sideClass = side === 'groom' ? 'text-blue-400' : 'text-pink-400';
        
        let rsvpDisplay;
        const totalAllowed = 1 + (data.companionsAllowed ?? 0);

        if (rsvpRaw === 'نعم') {
            const partySize = 1 + (data.companionsConfirmed ?? 0);
            rsvpDisplay = `${rsvp} (${partySize} / ${totalAllowed})`;
        } else if (rsvpRaw === 'لا') {
            rsvpDisplay = rsvp;
        } else { // No response
            rsvpDisplay = `${rsvp} (0 / ${totalAllowed})`;
        }

        const shareMessage = encodeURIComponent(`${translations[currentLang].shareMessage}${data.link}`);
        const whatsappLink = `https://wa.me/?text=${shareMessage}`;
        tableHTML += `<tr id="row-${key}" class="border-b border-white/10 hover:bg-white/5 transition-colors">
            <td class="py-2 px-2 font-semibold text-white">${data['الإسم'] || ''}</td>
            <td class="py-2 px-2 font-semibold ${sideClass}">${sideText}</td>
            <td class="py-2 px-2 font-bold ${rsvpClass}">${rsvpDisplay}</td>
            <td class="py-2 px-2"><div class="flex items-center justify-start gap-x-3">
                ${data.link ? `<a href="${data.link}" target="_blank" title="${translations[currentLang].viewCard}" class="text-indigo-400 hover:text-indigo-300 transition-colors"><span class="material-symbols-outlined">visibility</span></a>` : ''}
                ${data.link ? `<a href="${whatsappLink}" target="_blank" title="${translations[currentLang].share}" class="text-green-400 hover:text-green-300 transition-colors"><span class="material-symbols-outlined">share</span></a>` : ''}
                <button data-guest-id="${key}" data-guest-side="${side}" title="${translations[currentLang].delete}" class="delete-btn text-red-500 hover:text-red-400 transition-colors"><span class="material-symbols-outlined">delete</span></button>
            </div></td>
        </tr>`;
    });
    tableHTML += `</tbody></table></div>`;
    outputDiv.innerHTML = tableHTML;
}

function readData() { 
    if (!currentUser) return;
    onValue(databaseRef(database, `guests/${currentUser.uid}`), snapshot => {
        const data = snapshot.val() || {};
        allGuests.groom = data.groom ? Object.entries(data.groom).map(([key, value]) => ({ key, data: value, side: 'groom' })) : [];
        allGuests.bride = data.bride ? Object.entries(data.bride).map(([key, value]) => ({ key, data: value, side: 'bride' })) : [];
        
        // Calculate and display summary
        let groomCount = 0;
        allGuests.groom.forEach(guest => {
            if (guest.data['حضور'] === 'نعم') {
                groomCount += 1 + (guest.data.companionsConfirmed || 0);
            }
        });

        let brideCount = 0;
        allGuests.bride.forEach(guest => {
            if (guest.data['حضور'] === 'نعم') {
                brideCount += 1 + (guest.data.companionsConfirmed || 0);
            }
        });

        document.getElementById('groom-count').textContent = groomCount;
        document.getElementById('bride-count').textContent = brideCount;
        document.getElementById('total-count').textContent = groomCount + brideCount;

        renderGuestList();
    }); 
}

// ---- Modal Logic ----
const deleteConfirmModal = document.getElementById('delete-confirm-modal');
const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
let guestToDelete = { id: null, side: null };

function showDeleteConfirmModal(guestId, side) {
    guestToDelete = { id: guestId, side: side };
    deleteConfirmModal.classList.remove('hidden');
}

function hideDeleteConfirmModal() {
    guestToDelete = { id: null, side: null };
    deleteConfirmModal.classList.add('hidden');
}

async function performDelete() {
    if (!currentUser || !guestToDelete.id || !guestToDelete.side) return;
    
    const { id, side } = guestToDelete;
    const guestRef = databaseRef(database, `guests/${currentUser.uid}/${side}/${id}`);
    try {
        await remove(guestRef);
        showNotification(translations[currentLang].deleteSuccess, 'yellow');
    } catch (error) {
        showNotification(`${translations[currentLang].deleteError}${error.message}`, 'red');
    } finally {
        hideDeleteConfirmModal();
    }
}

cancelDeleteBtn.addEventListener('click', hideDeleteConfirmModal);
confirmDeleteBtn.addEventListener('click', performDelete);


document.getElementById('side-selector').addEventListener('click', (e) => {
    const button = e.target.closest('.side-btn');
    if (button) {
        currentSide = button.dataset.side;
        localStorage.setItem('managerCurrentSide', currentSide);
        document.querySelectorAll('.side-btn').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        updateActiveDesign();
    }
});

document.getElementById('guest-list-tabs').addEventListener('click', (e) => {
    const button = e.target.closest('.guest-tab');
    if (button) {
        currentGuestTab = button.dataset.tab;
        document.querySelectorAll('.guest-tab').forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        renderGuestList();
    }
});

document.getElementById('output').addEventListener('click', (e) => {
    const button = e.target.closest('.delete-btn');
    if (button) {
        const guestId = button.dataset.guestId;
        const side = button.dataset.guestSide;
        if (guestId && side) {
            showDeleteConfirmModal(guestId, side);
        }
    }
});

function showNotification(message, type = 'green') {
    const notification = document.getElementById('notification');
    const colors = { green: 'bg-emerald-500/90 border border-emerald-400/50', red: 'bg-rose-500/90 border border-rose-400/50', yellow: 'bg-amber-400/90 border border-amber-300/50' };
    notification.className = `fixed top-5 z-50 text-white py-3 px-6 rounded-lg shadow-xl transform transition-transform duration-500 ease-in-out ${colors[type] || 'bg-gray-500'}`;
    notification.textContent = message;

    const isRTL = document.documentElement.dir === 'rtl';
    const hiddenTransform = isRTL ? 'translateX(-120%)' : 'translateX(120%)';

    notification.classList.remove('left-5', 'right-5');
    notification.classList.add(isRTL ? 'left-5' : 'right-5');
    notification.style.transform = hiddenTransform;

    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);

    setTimeout(() => {
        notification.style.transform = hiddenTransform;
    }, 4000);
}
</script>
</body>
</html>
