
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Template Composer</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Dancing+Script:wght@700&family=Roboto:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --font-main: 'Plus Jakarta Sans', sans-serif; }
  html[lang="ar"] { --font-main: 'Cairo', sans-serif; }
  body {
    font-family: var(--font-main);
    background-color: #0f172a;
    background-image:
      radial-gradient(at 20% 25%, hsla(212,80%,30%,0.3) 0px, transparent 50%),
      radial-gradient(at 80% 20%, hsla(280,75%,40%,0.3) 0px, transparent 50%),
      radial-gradient(at 50% 80%, hsla(320,70%,50%,0.2) 0px, transparent 50%);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
  }
  .btn-primary {
    @apply font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 ease-in-out;
    background: linear-gradient(90deg, #6366F1, #8B5CF6);
    box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.5);
  }
  .btn-primary:hover:not(:disabled) {
    @apply shadow-2xl scale-105;
  }
   .btn-secondary {
    @apply font-semibold py-2 px-4 rounded-lg text-gray-300 transition-all duration-300 ease-in-out bg-slate-700/50 hover:bg-slate-600/50 border border-slate-600;
  }
  .canvas-container { border: 1px solid rgba(255, 255, 255, 0.1); }
</style>
</head>
<body class="text-gray-200" style="display: none;">

<header class="bg-slate-900/50 backdrop-blur-lg border-b border-white/10 sticky top-0 z-20">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-100" data-lang-key="headerTitle">Template Composer</h1>
    <div class="flex items-center gap-4">
        <a href="index.html" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors" data-lang-key="backToHub">&larr; Back to Hub</a>
        <button id="lang-switcher" class="font-bold text-sm border border-white/20 rounded-md px-3 py-1.5 hover:bg-white/10 transition-colors">AR</button>
        <button id="logout-button" class="font-bold text-sm bg-red-600/50 border border-red-500/30 text-red-300 rounded-md px-3 py-1.5 hover:bg-red-600/70 transition-colors" data-lang-key="logout">Logout</button>
    </div>
  </div>
</header>

<main class="container mx-auto p-4 md:p-8">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Toolbar -->
        <div class="lg:col-span-3 space-y-4">
            <div class="glass-card p-4 rounded-xl">
                <h3 class="font-bold mb-3 text-lg" data-lang-key="tools">Tools</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button id="set-bg" class="btn-secondary text-sm" data-lang-key="setBg">Set Background</button>
                    <input type="file" id="bg-uploader" class="hidden" accept="image/*">
                    <button id="add-text" class="btn-secondary text-sm" data-lang-key="addText">Add Text</button>
                    <button id="add-image" class="btn-secondary text-sm" data-lang-key="addImage">Add Image</button>
                    <input type="file" id="image-uploader" class="hidden" accept="image/*">
                    <button id="add-qr" class="btn-secondary text-sm" data-lang-key="addQr">Add QR Code</button>
                    <button id="delete-selected" class="btn-secondary text-sm bg-red-900/50 border-red-500/20 hover:bg-red-800/50" data-lang-key="delete">Delete Selected</button>
                </div>
            </div>
            <!-- Properties Panel -->
            <div id="properties-panel" class="glass-card p-4 rounded-xl"></div>
        </div>
        <!-- Canvas -->
        <div class="lg:col-span-9">
            <div class="aspect-w-16 aspect-h-9 bg-slate-900/50 rounded-lg flex items-center justify-center overflow-hidden">
                <canvas id="composer-canvas"></canvas>
            </div>
             <button id="save-template" class="mt-6 w-full btn-primary" data-lang-key="saveBtn">Save Template & Continue &rarr;</button>
        </div>
    </div>
</main>
<div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-[120%] transition-transform duration-500 ease-in-out"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm';
    
    const firebaseConfig = { apiKey: "AIzaSyCuZVUBIA0oDQuPzRUQbMJCJZK32zmVaVQ", authDomain: "final-draft-8f39d.firebaseapp.com", databaseURL: "https://final-draft-8f39d-default-rtdb.firebaseio.com", projectId: "final-draft-8f39d", storageBucket: "final-draft-8f39d.appspot.com", messagingSenderId: "994437210054", appId: "1:994437210054:web:628c741b81ccf741175cc7" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => { if (!user) window.location.href = 'login.html'; else document.body.style.display = 'block'; });
    document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

    const translations = {
        en: { headerTitle: "Template Composer", backToHub: "← Back to Hub", tools: "Tools", setBg: "Set Background", addText: "Add Text", addImage: "Add Image", addQr: "Add QR Code", delete: "Delete", saveBtn: "Save Template & Continue →", logout: "Logout", guestName: "Guest Name", qrPlaceholder: "QR Placeholder", templateSaved: "Template saved! Redirecting...", propText: "Text Properties", propFont: "Font", propColor: "Color", propSize: "Size", propBold: "Bold", propItalic: "Italic", propImage: "Image Properties", propOpacity: "Opacity", propQr: "QR Code Properties", propModules: "Modules", propBg: "Background" },
        ar: { headerTitle: "مصمم القوالب", backToHub: "→ العودة للمركز", tools: "الأدوات", setBg: "تعيين الخلفية", addText: "إضافة نص", addImage: "إضافة صورة", addQr: "إضافة رمز QR", delete: "حذف", saveBtn: "حفظ القالب والمتابعة ←", logout: "تسجيل الخروج", guestName: "اسم الضيف", qrPlaceholder: "رمز QR", templateSaved: "تم حفظ القالب! جارٍ إعادة التوجيه...", propText: "خصائص النص", propFont: "الخط", propColor: "اللون", propSize: "الحجم", propBold: "عريض", propItalic: "مائل", propImage: "خصائص الصورة", propOpacity: "الشفافية", propQr: "خصائص QR", propModules: "الوحدات", propBg: "الخلفية" }
    };
    let currentLang = localStorage.getItem('language') || 'en';
    const setLanguage = (lang) => { localStorage.setItem('language', lang); currentLang = lang; document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; document.getElementById('lang-switcher').textContent = lang === 'ar' ? 'EN' : 'AR'; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (translations[lang][key]) el.textContent = translations[lang][key]; }); document.title = translations[lang].headerTitle; };
    document.getElementById('lang-switcher').addEventListener('click', () => setLanguage(currentLang === 'en' ? 'ar' : 'en'));
    document.addEventListener('DOMContentLoaded', () => setLanguage(currentLang));

    const canvasContainer = document.querySelector('.aspect-w-16');
    const canvasEl = document.getElementById('composer-canvas');
    const propertiesPanel = document.getElementById('properties-panel');
    const canvas = new fabric.Canvas(canvasEl, { width: canvasContainer.clientWidth, height: canvasContainer.clientHeight });

    const resizeCanvas = () => {
        canvas.setWidth(canvasContainer.clientWidth);
        canvas.setHeight(canvasContainer.clientHeight);
        canvas.renderAll();
    };
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    
    // Tool Listeners
    document.getElementById('set-bg').addEventListener('click', () => document.getElementById('bg-uploader').click());
    document.getElementById('bg-uploader').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (f) => {
            fabric.Image.fromURL(f.target.result, (img) => {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: canvas.width / img.width,
                    scaleY: canvas.height / img.height
                });
            });
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('add-text').addEventListener('click', () => {
        const text = new fabric.IText(translations[currentLang].guestName, {
            left: 50, top: 50, fontFamily: 'Roboto', fill: '#ffffff',
            customId: 'guestNamePlaceholder' // Special ID for replacement
        });
        canvas.add(text);
        canvas.setActiveObject(text);
    });
    
    document.getElementById('add-image').addEventListener('click', () => document.getElementById('image-uploader').click());
    document.getElementById('image-uploader').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (f) => {
            fabric.Image.fromURL(f.target.result, (img) => {
                img.scaleToWidth(150);
                canvas.add(img);
                canvas.setActiveObject(img);
            });
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('add-qr').addEventListener('click', async () => {
        const qrDataUrl = await QRCode.toDataURL('PREVIEW', { width: 200, margin: 1 });
        fabric.Image.fromURL(qrDataUrl, (img) => {
            img.set({ left: 100, top: 100, customId: 'qrPlaceholder' });
            canvas.add(img);
            canvas.setActiveObject(img);
        });
    });

    document.getElementById('delete-selected').addEventListener('click', () => {
        canvas.remove(canvas.getActiveObject());
        updatePropertiesPanel();
    });
    
    // Properties Panel Logic
    const updatePropertiesPanel = () => {
        propertiesPanel.innerHTML = '';
        const activeObject = canvas.getActiveObject();
        if (!activeObject) return;

        if (activeObject.type === 'i-text') {
            propertiesPanel.innerHTML = `
                <h4 class="font-bold mb-2" data-lang-key="propText">Text Properties</h4>
                <div class="space-y-2">
                    <div><label class="text-xs" data-lang-key="propFont">Font</label><select id="font-family" class="w-full bg-slate-800 border border-slate-600 rounded p-1 text-xs"><option>Roboto</option><option>Amiri</option><option>Dancing Script</option></select></div>
                    <div><label class="text-xs" data-lang-key="propColor">Color</label><input type="color" id="fill-color" class="w-full"></div>
                    <div><label class="text-xs" data-lang-key="propSize">Size</label><input type="range" id="font-size" min="10" max="150" value="${activeObject.get('fontSize')}"></div>
                    <div class="flex gap-4"><label><input type="checkbox" id="font-bold"> <span data-lang-key="propBold">Bold</span></label><label><input type="checkbox" id="font-italic"> <span data-lang-key="propItalic">Italic</span></label></div>
                </div>`;
            setLanguage(currentLang);
            document.getElementById('font-family').value = activeObject.get('fontFamily');
            document.getElementById('fill-color').value = activeObject.get('fill');
            document.getElementById('font-bold').checked = activeObject.get('fontWeight') === 'bold';
            document.getElementById('font-italic').checked = activeObject.get('fontStyle') === 'italic';
            
            document.getElementById('font-family').addEventListener('change', (e) => { activeObject.set('fontFamily', e.target.value); canvas.renderAll(); });
            document.getElementById('fill-color').addEventListener('input', (e) => { activeObject.set('fill', e.target.value); canvas.renderAll(); });
            document.getElementById('font-size').addEventListener('input', (e) => { activeObject.set('fontSize', parseInt(e.target.value, 10)); canvas.renderAll(); });
            document.getElementById('font-bold').addEventListener('change', (e) => { activeObject.set('fontWeight', e.target.checked ? 'bold' : 'normal'); canvas.renderAll(); });
            document.getElementById('font-italic').addEventListener('change', (e) => { activeObject.set('fontStyle', e.target.checked ? 'italic' : 'normal'); canvas.renderAll(); });

        } else if (activeObject.type === 'image' && activeObject.customId !== 'qrPlaceholder') {
             propertiesPanel.innerHTML = `
                <h4 class="font-bold mb-2" data-lang-key="propImage">Image Properties</h4>
                <div><label class="text-xs" data-lang-key="propOpacity">Opacity</label><input type="range" id="opacity" min="0" max="1" step="0.05" value="${activeObject.get('opacity')}"></div>`;
             setLanguage(currentLang);
             document.getElementById('opacity').addEventListener('input', (e) => { activeObject.set('opacity', parseFloat(e.target.value)); canvas.renderAll(); });

        } else if (activeObject.customId === 'qrPlaceholder') {
            propertiesPanel.innerHTML = `<h4 class="font-bold mb-2" data-lang-key="propQr">QR Code Properties</h4>
                <p class="text-xs text-slate-400">Colors and content will be set during guest generation.</p>`;
             setLanguage(currentLang);
        }
    };
    
    canvas.on('selection:created', updatePropertiesPanel);
    canvas.on('selection:updated', updatePropertiesPanel);
    canvas.on('selection:cleared', updatePropertiesPanel);

    // Save Logic
    document.getElementById('save-template').addEventListener('click', () => {
        // Remove old simple template if it exists
        localStorage.removeItem('cardTemplate'); 
        const templateJson = JSON.stringify(canvas.toJSON(['customId']));
        localStorage.setItem('composedCardTemplate', templateJson);
        const notification = document.getElementById('notification');
        notification.textContent = translations[currentLang].templateSaved;
        notification.style.transform = 'translateX(0)';
        setTimeout(() => {
            notification.style.transform = 'translateX(120%)';
            window.location.href = 'manager.html';
        }, 1500);
    });

</script>
</body>
</html>
