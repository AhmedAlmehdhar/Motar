
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step 1: Design Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Dancing+Script:wght@700&family=Roboto:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --font-main: 'Plus Jakarta Sans', sans-serif; }
  html[lang="ar"] { --font-main: 'Cairo', sans-serif; }
  body {
    font-family: var(--font-main);
    background-color: #0f172a;
    background-image:
      radial-gradient(at 20% 25%, hsla(212,80%,30%,0.3) 0px, transparent 50%),
      radial-gradient(at 80% 20%, hsla(280,75%,40%,0.3) 0px, transparent 50%),
      radial-gradient(at 50% 80%, hsla(320,70%,50%,0.2) 0px, transparent 50%);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
  }
  .btn-primary {
    @apply font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 ease-in-out;
    background: linear-gradient(90deg, #6366F1, #8B5CF6);
    box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.5);
  }
  .btn-primary:hover:not(:disabled) {
    @apply shadow-2xl scale-105;
    box-shadow: 0 6px 20px 0 rgba(116, 79, 168, 0.65);
  }
  .btn-primary:disabled { background: #374151; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.6; }
  #positioning-area { touch-action: none; background-size: cover; background-position: center; }
  .placeholder {
    position: absolute; cursor: move; user-select: none; top: 0; left: 0;
    display: flex; align-items: center; justify-content: center;
    border: 2px dashed rgba(255, 255, 255, 0.7);
  }
  #qr-placeholder-img, #location-qr-placeholder-img { max-width: 100%; height: auto; }
  #image-drop-area { border: 2px dashed rgba(255, 255, 255, 0.2); }
  #image-drop-area.dragover { border-color: #8B5CF6; background-color: rgba(139, 92, 246, 0.1); }
  input[type="range"]::-webkit-slider-thumb { @apply bg-indigo-400; }
  input[type="range"]::-moz-range-thumb { @apply bg-indigo-400; }
  .template-thumb {
    @apply rounded-lg border-2 border-transparent transition-all duration-200 cursor-pointer overflow-hidden;
  }
  .template-thumb:hover { @apply border-indigo-400 scale-105; }
  .template-thumb.selected { @apply border-indigo-500 ring-4 ring-indigo-500/50; }
  .eyedropper-btn {
    width: 28px; height: 28px; border-radius: 50%; border: 1px solid #64748b;
    cursor: pointer; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12.001 2.003c-5.518 0-9.996 4.478-9.996 9.997 0 5.518 4.478 9.995 9.996 9.995 5.518 0 9.996-4.477 9.996-9.995 0-5.519-4.478-9.997-9.996-9.997zm0 18.175c-4.514 0-8.176-3.663-8.176-8.178s3.662-8.179 8.176-8.179 8.176 3.664 8.176 8.179-3.662 8.178-8.176 8.178zm-.75-3.321v-4.502h-4.502v-1.5h4.502V6.353h1.5v4.502h4.5v1.5h-4.5v4.502z" transform="rotate(45 12 12)"/></svg>');
    background-size: 16px; background-position: center; background-repeat: no-repeat;
    transition: background-color 0.2s;
  }
  .eyedropper-btn:hover { background-color: #4f46e5; }
</style>
</head>
<body class="text-gray-200" style="display: none;">

<header class="bg-slate-900/50 backdrop-blur-lg border-b border-white/10 sticky top-0 z-20">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-100" data-lang-key="headerTitle">Step 1: Design Your Card</h1>
    <div class="flex items-center gap-4">
        <a href="index.html" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors" data-lang-key="backToHub">&larr; Back to Hub</a>
        <button id="lang-switcher" class="font-bold text-sm border border-white/20 rounded-md px-3 py-1.5 hover:bg-white/10 transition-colors">AR</button>
        <button id="logout-button" class="font-bold text-sm bg-red-600/50 border border-red-500/30 text-red-300 rounded-md px-3 py-1.5 hover:bg-red-600/70 transition-colors" data-lang-key="logout">Logout</button>
    </div>
  </div>
</header>

<main class="container mx-auto p-4 md:p-8 flex justify-center">
  <div class="w-full max-w-7xl">
    
    <div id="side-selection-section" class="glass-card p-6 rounded-2xl text-center">
        <h2 class="text-2xl font-semibold text-gray-100 mb-2" data-lang-key="sideSelectTitle">Design a Card</h2>
        <p class="text-sm text-gray-400 mb-6" data-lang-key="sideSelectDesc">Which invitation side are you creating or editing?</p>
        <div class="flex gap-4 justify-center">
            <button data-side="groom" class="btn-primary flex-1" data-lang-key="groomSide">Groom's Side</button>
            <button data-side="bride" class="btn-primary flex-1" data-lang-key="brideSide">Bride's Side</button>
        </div>
    </div>

    <div id="template-section" class="hidden">
      <div class="glass-card p-6 rounded-2xl">
        <button id="back-to-side-select" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors mb-4">&larr; <span data-lang-key="backBtn">Back</span></button>
        <h2 class="text-xl font-semibold text-gray-100 mb-2" data-lang-key="templateSelectTitle">1. Choose a Template or Upload Your Own</h2>
        <div id="template-gallery" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
        <div id="uploader-section">
          <p class="text-sm text-center text-gray-400 mb-4" data-lang-key="orUpload">Or upload a custom design (JPG, PNG, GIF)</p>
          <div id="image-drop-area" class="relative flex flex-col items-center justify-center w-full h-48 rounded-lg cursor-pointer bg-white/5 hover:bg-white/10 transition-colors">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                  <svg class="w-8 h-8 mb-3 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                  <p class="mb-2 text-sm text-gray-400"><span class="font-semibold" data-lang-key="clickToUpload">Click to upload</span><span data-lang-key="orDragDrop"> or drag and drop</span></p>
              </div>
              <input type="file" id="imageUploader" accept="image/jpeg,image/png,image/gif" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
          </div>
          <img id="imagePreview" class="mt-4 rounded-md hidden border-2 border-white/10 w-full max-w-sm mx-auto" alt="Image Preview"/>
        </div>
        <button id="continue-to-editor-btn" class="mt-6 w-full btn-primary" data-lang-key="continueBtn" disabled>Continue to Editor</button>
        <div id="uploadSpinner" class="hidden mt-4 text-center"><div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-indigo-400" role="status"></div><p class="text-sm text-gray-400 mt-2" data-lang-key="uploading">Uploading to secure storage...</p></div>
      </div>
    </div>

    <div id="editor-section" class="hidden">
      <div class="glass-card p-6 rounded-2xl">
        <button id="back-to-templates" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors mb-4">&larr; <span data-lang-key="backBtn">Back</span></button>
        <h2 class="text-xl font-semibold text-gray-100 mb-2" data-lang-key="editorTitle">2. Position & Style Details</h2>
        <p class="text-sm text-gray-400 mb-6" data-lang-key="editorDesc">Drag the placeholders to position them. Use the controls on the right to customize their appearance.</p>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div id="positioning-area" class="lg:col-span-2 relative aspect-[9/16] w-full max-w-md mx-auto select-none overflow-hidden rounded-lg border-2 border-white/10 bg-black">
            <div id="name-placeholder" class="placeholder p-2 font-bold" style="color: white; font-family: 'Roboto', sans-serif;" data-lang-key="guestName">Guest Name</div>
            <div id="qr-placeholder" class="placeholder"><img id="qr-placeholder-img" src="" alt="Guest QR Code Preview"/></div>
            <div id="location-qr-placeholder" class="placeholder"><img id="location-qr-placeholder-img" src="" alt="Location QR Code Preview"/></div>
          </div>
          <div class="space-y-4">
              <div class="bg-slate-800/50 p-4 rounded-lg">
                <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="optionalElements">Optional Elements</h3>
                <div class="space-y-3">
                  <label class="flex items-center"><input type="checkbox" id="include-name-toggle" class="h-4 w-4 rounded text-indigo-500 bg-slate-700 border-slate-600 focus:ring-indigo-600"><span class="ms-2 text-sm font-medium text-gray-300" data-lang-key="includeGuestName">Include Guest Name</span></label>
                  <label class="flex items-center"><input type="checkbox" id="include-location-qr-toggle" class="h-4 w-4 rounded text-indigo-500 bg-slate-700 border-slate-600 focus:ring-indigo-600"><span class="ms-2 text-sm font-medium text-gray-300" data-lang-key="includeLocationQR">Include Location QR</span></label>
                  <div id="location-url-group" class="hidden"><label for="location-url" class="text-xs text-gray-400" data-lang-key="locationUrl">Google Maps URL</label><input type="url" id="location-url" placeholder="https://maps.app.goo.gl/..." class="w-full text-xs p-2 bg-slate-700 border border-slate-600 rounded-lg"></div>
                </div>
              </div>

              <div id="name-customization-group" class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="nameStyleTitle">Guest Name Customization</h3>
                  <!-- Name controls here -->
              </div>
              <div id="guest-qr-customization-group" class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="qrStyleTitle">Guest QR Code</h3>
                  <!-- Guest QR controls here -->
              </div>
              <div id="location-qr-customization-group" class="hidden bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="locationQrStyleTitle">Location QR Code</h3>
                   <!-- Location QR controls here -->
              </div>
          </div>
        </div>
        <button id="save-positions-button" class="mt-8 w-full btn-primary" data-lang-key="saveBtn">Save Design & Continue &rarr;</button>
      </div>
    </div>
  </div>
</main>
<div id="notification" class="fixed top-5 right-5 rtl:right-auto rtl:left-5 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-full rtl:-translate-x-full opacity-0 transition-all duration-500 ease-in-out z-50"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm';

    const firebaseConfig = { apiKey: "AIzaSyCuZVUBIA0oDQuPzRUQbMJCJZK32zmVaVQ", authDomain: "final-draft-8f39d.firebaseapp.com", databaseURL: "https://final-draft-8f39d-default-rtdb.firebaseio.com", projectId: "final-draft-8f39d", storageBucket: "final-draft-8f39d.appspot.com", messagingSenderId: "994437210054", appId: "1:994437210054:web:628c741b81ccf741175cc7" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    document.getElementById('logout-button').addEventListener('click', () => { signOut(auth); });
    
    const translations = {
        en: { 
            headerTitle: "Step 1: Design Your Card", backToHub: "← Back to Hub", backBtn: "Back",
            sideSelectTitle: "Design a Card", sideSelectDesc: "Which invitation side are you creating or editing?", groomSide: "Groom's Side", brideSide: "Bride's Side",
            templateSelectTitle: "1. Choose a Template or Upload Your Own", orUpload: "Or upload a custom design (JPG, PNG, GIF)",
            clickToUpload: "Click to upload", orDragDrop: " or drag and drop",
            continueBtn: "Continue to Editor", uploading: "Uploading to secure storage...", 
            editorTitle: "2. Position & Style Details", editorDesc: "Drag the placeholders to position them. Use the controls on the right to customize their appearance.",
            guestName: "Guest Name", 
            optionalElements: "Optional Elements", includeGuestName: "Include Guest Name", includeLocationQR: "Include Location QR", locationUrl: "Google Maps URL",
            nameStyleTitle: "Guest Name Customization", fontColor: "Font Color", fontFamily: "Font Family", fontSize: "Font Size", rotation: "Rotation", bold: "Bold", italic: "Italic", textShadow: "Text Shadow", textStroke: "Text Stroke", 
            qrStyleTitle: "Guest QR Code", qrSize: "Size",
            locationQrStyleTitle: "Location QR Code",
            saveBtn: "Save Design & Continue →", selectImageFirst: "Please select a template or upload an image first", uploadSuccess: "Upload successful!", uploadFailed: "Image upload failed: ", designSaved: "Design saved! Redirecting...", logout: "Logout" 
        },
        ar: { 
            headerTitle: "الخطوة ١: تصميم بطاقتك", backToHub: "→ العودة للمركز", backBtn: "رجوع",
            sideSelectTitle: "تصميم بطاقة", sideSelectDesc: "أي جانب من الدعوة تقوم بتصميمه أو تعديله؟", groomSide: "جهة العريس", brideSide: "جهة العروس",
            templateSelectTitle: "١. اختر قالبًا أو ارفع تصميمك الخاص", orUpload: "أو ارفع تصميمًا مخصصًا (JPG, PNG, GIF)",
            clickToUpload: "انقر للرفع", orDragDrop: " أو اسحب وأفلت",
            continueBtn: "متابعة إلى المحرر", uploading: "جاري الرفع إلى التخزين الآمن...", 
            editorTitle: "٢. تحديد أماكن وتنسيق التفاصيل", editorDesc: "اسحب العناصر لتحديد أماكنها. استخدم عناصر التحكم على اليسار لتخصيص مظهرها.", 
            guestName: "اسم الضيف",
            optionalElements: "عناصر اختيارية", includeGuestName: "إضافة اسم الضيف", includeLocationQR: "إضافة رمز QR للموقع", locationUrl: "رابط خرائط جوجل",
            nameStyleTitle: "تخصيص اسم الضيف", fontColor: "لون الخط", fontFamily: "نوع الخط", fontSize: "حجم الخط", rotation: "دوران", bold: "عريض", italic: "مائل", textShadow: "ظل النص", textStroke: "إطار النص", 
            qrStyleTitle: "رمز QR للضيف", qrSize: "الحجم",
            locationQrStyleTitle: "رمز QR للموقع",
            saveBtn: "حفظ التصميم والمتابعة ←", selectImageFirst: "الرجاء اختيار قالب أو رفع صورة أولاً", uploadSuccess: "تم الرفع بنجاح!", uploadFailed: "فشل رفع الصورة: ", designSaved: "تم حفظ التصميم! جارٍ إعادة التوجيه...", logout: "تسجيل الخروج"
        }
    };
    const langSwitcher = document.getElementById('lang-switcher');
    
    const setLanguage = (lang) => {
        localStorage.setItem('language', lang);
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
        langSwitcher.textContent = lang === 'ar' ? 'EN' : 'AR';
        document.querySelectorAll('[data-lang-key]').forEach(element => {
            const key = element.getAttribute('data-lang-key');
            if (translations[lang][key]) {
                element.textContent = translations[lang][key];
            }
        });
    };
    langSwitcher.addEventListener('click', () => {
        const currentLang = localStorage.getItem('language') || 'en';
        setLanguage(currentLang === 'en' ? 'ar' : 'en');
    });
    
    // --- APP LOGIC START ---

    const IMGBB_API_KEY = '97c60166127ae9258012f463e09b1e2d';
    let DOMElements = {};
    
    const PRESET_TEMPLATES = [ "https://i.ibb.co/6r0M7r1/template1.jpg", "https://i.ibb.co/RPKC6rY/template2.jpg", "https://i.ibb.co/pzv5pJR/template3.jpg", "https://i.ibb.co/3kCg53g/template4.jpg" ];
    const FONT_OPTIONS = ['Amiri', 'Cairo', 'Roboto', 'Dancing Script'];

    let designs = { groom: null, bride: null };
    let currentSide = null;
    let selectedFile = null;
    let selectedCardImageUrl = null;
    let settings = {};
    let notificationTimeout;

    function initializeEditor() {
        // Defer DOM element selection until app starts
        DOMElements = {
            sideSelection: document.getElementById('side-selection-section'),
            templateSection: document.getElementById('template-section'),
            editorSection: document.getElementById('editor-section'),
            imageUploader: document.getElementById('imageUploader'),
            imagePreview: document.getElementById('imagePreview'),
            continueToEditorBtn: document.getElementById('continue-to-editor-btn'),
            uploadSpinner: document.getElementById('uploadSpinner'),
            imageDropArea: document.getElementById('image-drop-area'),
            positioningArea: document.getElementById('positioning-area'),
            namePlaceholder: document.getElementById('name-placeholder'),
            qrPlaceholder: document.getElementById('qr-placeholder'),
            qrPlaceholderImg: document.getElementById('qr-placeholder-img'),
            locationQrPlaceholder: document.getElementById('location-qr-placeholder'),
            locationQrPlaceholderImg: document.getElementById('location-qr-placeholder-img'),
            savePositionsButton: document.getElementById('save-positions-button'),
            notification: document.getElementById('notification'),
            templateGallery: document.getElementById('template-gallery'),
            includeNameToggle: document.getElementById('include-name-toggle'),
            includeLocationQrToggle: document.getElementById('include-location-qr-toggle'),
            locationUrlGroup: document.getElementById('location-url-group'),
            locationUrlInput: document.getElementById('location-url'),
            nameCustomizationGroup: document.getElementById('name-customization-group'),
            guestQrCustomizationGroup: document.getElementById('guest-qr-customization-group'),
            locationQrCustomizationGroup: document.getElementById('location-qr-customization-group'),
            backToSideSelectBtn: document.getElementById('back-to-side-select'),
            backToTemplatesBtn: document.getElementById('back-to-templates'),
        };

        try {
            const savedDesigns = JSON.parse(localStorage.getItem('invitationDesigns'));
            if (savedDesigns) { designs = savedDesigns; }
        } catch (e) {
            console.error("Could not parse designs from localStorage:", e);
            localStorage.removeItem('invitationDesigns'); // Clear corrupted data
        }
        
        setupEventListeners();
        populateTemplateGallery();
        
        Promise.all([
            QRCode.toDataURL('Guest123', { errorCorrectionLevel: 'H', margin: 2, color: { dark: '#000000', light: '#FFFFFF' } }),
            QRCode.toDataURL('https://maps.google.com', { errorCorrectionLevel: 'H', margin: 2, color: { dark: '#000000', light: '#FFFFFF' } })
        ]).then(([guestUrl, locUrl]) => {
            DOMElements.qrPlaceholderImg.src = guestUrl;
            DOMElements.locationQrPlaceholderImg.src = locUrl;
        }).catch(err => {
            console.error("Failed to generate placeholder QR codes:", err);
        });
    }

    function populateTemplateGallery() {
        DOMElements.templateGallery.innerHTML = '';
        PRESET_TEMPLATES.forEach(url => {
            const thumb = document.createElement('img');
            thumb.src = url;
            thumb.className = 'template-thumb';
            thumb.dataset.url = url;
            DOMElements.templateGallery.appendChild(thumb);
        });
    }

    function setupEventListeners() {
        DOMElements.sideSelection.addEventListener('click', handleSideSelection);
        DOMElements.templateGallery.addEventListener('click', handleTemplateSelection);
        DOMElements.imageDropArea.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.classList.add('dragover'); });
        DOMElements.imageDropArea.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('dragover'));
        DOMElements.imageDropArea.addEventListener('drop', handleFileDrop);
        DOMElements.imageUploader.addEventListener('change', handleFileSelect);
        DOMElements.continueToEditorBtn.addEventListener('click', handleContinueToEditor);
        DOMElements.savePositionsButton.addEventListener('click', saveAndContinue);
        DOMElements.backToSideSelectBtn.addEventListener('click', () => showSection('sideSelection'));
        DOMElements.backToTemplatesBtn.addEventListener('click', () => showSection('template'));
        
        DOMElements.includeNameToggle.addEventListener('change', updateOptionalElementsVisibility);
        DOMElements.includeLocationQrToggle.addEventListener('change', updateOptionalElementsVisibility);
        DOMElements.locationUrlInput.addEventListener('input', () => {
            updateLocationQrCode(DOMElements.locationUrlInput.value);
        });
    }

    function showSection(section) {
        DOMElements.sideSelection.classList.add('hidden');
        DOMElements.templateSection.classList.add('hidden');
        DOMElements.editorSection.classList.add('hidden');
        if (section === 'sideSelection') DOMElements.sideSelection.classList.remove('hidden');
        if (section === 'template') DOMElements.templateSection.classList.remove('hidden');
        if (section === 'editor') DOMElements.editorSection.classList.remove('hidden');
    }

    function handleSideSelection(e) {
        if (e.target.tagName === 'BUTTON') {
            currentSide = e.target.dataset.side;
            showSection('template');
            resetTemplateSelection();
            if (designs[currentSide]?.imageUrl) {
                selectedCardImageUrl = designs[currentSide].imageUrl;
                selectTemplateThumbnail(selectedCardImageUrl);
                DOMElements.continueToEditorBtn.disabled = false;
            }
        }
    }

    function resetTemplateSelection() {
        selectedFile = null;
        selectedCardImageUrl = null;
        DOMElements.imagePreview.src = '';
        DOMElements.imagePreview.classList.add('hidden');
        DOMElements.imageUploader.value = '';
        document.querySelectorAll('.template-thumb.selected').forEach(t => t.classList.remove('selected'));
        DOMElements.continueToEditorBtn.disabled = true;
    }

    function selectTemplateThumbnail(url) {
        document.querySelectorAll('.template-thumb').forEach(thumb => {
            thumb.classList.toggle('selected', thumb.dataset.url === url);
        });
    }

    function handleTemplateSelection(e) {
        if (e.target.tagName === 'IMG') {
            resetTemplateSelection();
            selectedCardImageUrl = e.target.dataset.url;
            e.target.classList.add('selected');
            DOMElements.continueToEditorBtn.disabled = false;
        }
    }

    function handleFileDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) processFile(file);
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) processFile(file);
    }
    
    function processFile(file) {
        resetTemplateSelection();
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            DOMElements.imagePreview.src = e.target.result;
            DOMElements.imagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
        DOMElements.continueToEditorBtn.disabled = false;
    }
    
    async function handleContinueToEditor() {
        const currentLang = localStorage.getItem('language') || 'en';
        if (!selectedCardImageUrl && !selectedFile) {
            showNotification(translations[currentLang].selectImageFirst, 'yellow');
            return;
        }
        if (selectedFile) {
            try {
                DOMElements.uploadSpinner.classList.remove('hidden');
                DOMElements.continueToEditorBtn.disabled = true;
                const formData = new FormData();
                formData.append('image', selectedFile);
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    showNotification(translations[currentLang].uploadSuccess, 'green');
                    setupEditor(result.data.url);
                } else { throw new Error(result.error.message); }
            } catch (error) {
                showNotification(translations[currentLang].uploadFailed + error.message, 'red');
            } finally {
                DOMElements.uploadSpinner.classList.add('hidden');
                DOMElements.continueToEditorBtn.disabled = false;
            }
        } else {
            setupEditor(selectedCardImageUrl);
        }
    }

    function setupEditor(imageUrl) {
        showSection('editor');
        DOMElements.positioningArea.style.backgroundImage = `url(${imageUrl})`;
        
        settings = designs[currentSide] ? JSON.parse(JSON.stringify(designs[currentSide])) : createDefaultSettings();
        settings.imageUrl = imageUrl;
        
        const img = new Image();
        img.onload = () => {
            settings.imageWidth = img.width;
            settings.imageHeight = img.height;
            DOMElements.positioningArea.style.aspectRatio = `${img.width} / ${img.height}`;
            applyAllSettings();
        };
        img.src = imageUrl;

        createCustomizationControls();
        applyAllSettings();
    }
    
    function createDefaultSettings() {
        return {
            imageUrl: '', imageWidth: 540, imageHeight: 960,
            includeName: true, includeLocationQr: false, locationUrl: '',
            name: { position: { top: 70, left: 10 }, width: 80, style: { color: '#FFFFFF', fontFamily: 'Amiri', fontSize: 48, fontWeight: 'bold', fontStyle: 'normal', transform: 'rotate(0deg)', textShadow: 'none', webkitTextStroke: '0px black' } },
            guestQr: { position: { top: 80, left: 35 }, size: 30 },
            locationQr: { position: { top: 80, left: 35 }, size: 30 }
        };
    }

    function createCustomizationControls() {
        const currentLang = localStorage.getItem('language') || 'en';
        const nameGroup = DOMElements.nameCustomizationGroup;
        const guestQrGroup = DOMElements.guestQrCustomizationGroup;
        const locationQrGroup = DOMElements.locationQrCustomizationGroup;

        nameGroup.innerHTML = `<h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="nameStyleTitle">${translations[currentLang].nameStyleTitle}</h3>`;
        guestQrGroup.innerHTML = `<h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="qrStyleTitle">${translations[currentLang].qrStyleTitle}</h3>`;
        locationQrGroup.innerHTML = `<h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="locationQrStyleTitle">${translations[currentLang].locationQrStyleTitle}</h3>`;

        // Name Controls
        const createInput = (labelKey, type, id, value, container, onChange, options = {}) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'mb-3';
            const label = document.createElement('label');
            label.htmlFor = id;
            label.className = 'text-sm text-gray-400 block mb-1';
            label.dataset.langKey = labelKey;
            label.textContent = translations[currentLang][labelKey];
            
            let input;
            if (type === 'select') {
                input = document.createElement('select');
                options.choices.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    input.appendChild(opt);
                });
            } else {
                input = document.createElement('input');
                input.type = type;
            }

            if (type === 'color') {
                const colorWrapper = document.createElement('div');
                colorWrapper.className = 'flex items-center gap-2';
                input.className = 'w-16 h-9 p-1 bg-slate-700 border border-slate-600 rounded-lg cursor-pointer';
                
                const eyedropperBtn = document.createElement('button');
                eyedropperBtn.className = 'eyedropper-btn';
                eyedropperBtn.title = 'Pick color from image';
                eyedropperBtn.onclick = (e) => {
                    e.preventDefault();
                    if ('EyeDropper' in window) {
                        const eyeDropper = new window.EyeDropper();
                        eyeDropper.open().then(result => {
                            input.value = result.sRGBHex;
                            input.dispatchEvent(new Event('input'));
                            DOMElements.positioningArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }).catch(e => console.error(e));
                    } else { alert('Eyedropper API not supported in this browser.'); }
                };
                colorWrapper.append(input, eyedropperBtn);
                wrapper.append(label, colorWrapper);
            } else if (type === 'checkbox') {
                 const checkWrapper = document.createElement('label');
                 checkWrapper.className = 'flex items-center gap-2 cursor-pointer';
                 input.className = 'h-4 w-4 rounded text-indigo-500 bg-slate-700 border-slate-600 focus:ring-indigo-600';
                 checkWrapper.append(input, label);
                 wrapper.innerHTML = '';
                 wrapper.append(checkWrapper);
            } else {
                input.className = type === 'range' ? 'w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer' : 'w-full text-sm p-2 bg-slate-700 border border-slate-600 rounded-lg';
                wrapper.append(label, input);
            }
            
            input.id = id;
            input.value = value;
            if (type === 'checkbox') input.checked = value;
            Object.assign(input, options);
            input.addEventListener(type === 'range' ? 'input' : 'change', onChange);
            container.appendChild(wrapper);
        };
        
        // Name
        createInput('fontColor', 'color', 'name-color', settings.name.style.color, nameGroup, (e) => { settings.name.style.color = e.target.value; applyNameStyle(); });
        createInput('fontFamily', 'select', 'name-font', settings.name.style.fontFamily, nameGroup, (e) => { settings.name.style.fontFamily = e.target.value; applyNameStyle(); }, { choices: FONT_OPTIONS });
        createInput('fontSize', 'range', 'name-size', settings.name.style.fontSize, nameGroup, (e) => { settings.name.style.fontSize = e.target.value; applyNameStyle(); }, { min: 12, max: 120, step: 1 });
        createInput('rotation', 'range', 'name-rotation', (settings.name.style.transform.match(/-?\d+/) || ['0'])[0], nameGroup, (e) => { settings.name.style.transform = `rotate(${e.target.value}deg)`; applyNameStyle(); }, { min: -45, max: 45, step: 1 });
        createInput('bold', 'checkbox', 'name-bold', settings.name.style.fontWeight === 'bold', nameGroup, (e) => { settings.name.style.fontWeight = e.target.checked ? 'bold' : 'normal'; applyNameStyle(); });
        createInput('italic', 'checkbox', 'name-italic', settings.name.style.fontStyle === 'italic', nameGroup, (e) => { settings.name.style.fontStyle = e.target.checked ? 'italic' : 'normal'; applyNameStyle(); });

        // Guest QR
        createInput('qrSize', 'range', 'guest-qr-size', settings.guestQr.size, guestQrGroup, (e) => { settings.guestQr.size = e.target.value; applyQrStyle('guestQr'); }, { min: 5, max: 80, step: 1 });
        
        // Location QR
        createInput('qrSize', 'range', 'location-qr-size', settings.locationQr.size, locationQrGroup, (e) => { settings.locationQr.size = e.target.value; applyQrStyle('locationQr'); }, { min: 5, max: 80, step: 1 });
        
        dragElement(DOMElements.namePlaceholder, 'name');
        dragElement(DOMElements.qrPlaceholder, 'guestQr');
        dragElement(DOMElements.locationQrPlaceholder, 'locationQr');
    }

    function applyAllSettings() {
        applyNameStyle();
        applyQrStyle('guestQr');
        applyQrStyle('locationQr');
        
        DOMElements.includeNameToggle.checked = settings.includeName;
        DOMElements.includeLocationQrToggle.checked = settings.includeLocationQr;
        DOMElements.locationUrlInput.value = settings.locationUrl;
        updateOptionalElementsVisibility();
        updateLocationQrCode(settings.locationUrl);
    }
    
    function updateOptionalElementsVisibility() {
        settings.includeName = DOMElements.includeNameToggle.checked;
        settings.includeLocationQr = DOMElements.includeLocationQrToggle.checked;
        
        DOMElements.namePlaceholder.style.display = settings.includeName ? 'flex' : 'none';
        DOMElements.nameCustomizationGroup.style.display = settings.includeName ? 'block' : 'none';

        const showGuestQr = !(settings.includeLocationQr && !settings.locationUrl); // Show guest QR if location QR is disabled OR if it's enabled but has no URL yet (to avoid empty space)
        DOMElements.qrPlaceholder.style.display = showGuestQr ? 'flex' : 'none';
        DOMElements.guestQrCustomizationGroup.style.display = showGuestQr ? 'block' : 'none';
        
        DOMElements.locationQrPlaceholder.style.display = settings.includeLocationQr ? 'flex' : 'none';
        DOMElements.locationQrCustomizationGroup.style.display = settings.includeLocationQr ? 'block' : 'none';
        DOMElements.locationUrlGroup.style.display = settings.includeLocationQr ? 'block' : 'none';
    }

    async function updateLocationQrCode(url) {
        settings.locationUrl = url;
        if (url && settings.includeLocationQr) {
            try {
                const dataUrl = await QRCode.toDataURL(url, { errorCorrectionLevel: 'H', margin: 2 });
                DOMElements.locationQrPlaceholderImg.src = dataUrl;
            } catch (err) {
                console.error("QR Code generation failed:", err);
            }
        }
        updateOptionalElementsVisibility();
    }
    
    function applyNameStyle() {
        const placeholder = DOMElements.namePlaceholder;
        const s = settings.name;
        Object.assign(placeholder.style, s.style);
        const scale = DOMElements.positioningArea.offsetWidth / settings.imageWidth;
        placeholder.style.fontSize = `${s.style.fontSize * scale}px`;
        placeholder.style.width = `${s.width}%`;
        placeholder.style.left = `${s.position.left}%`;
        placeholder.style.top = `${s.position.top}%`;
    }
    
    function applyQrStyle(qrType) {
        const placeholder = qrType === 'guestQr' ? DOMElements.qrPlaceholder : DOMElements.locationQrPlaceholder;
        const s = settings[qrType];
        placeholder.style.width = `${s.size}%`;
        placeholder.style.height = `${s.size}%`;
        placeholder.style.left = `${s.position.left}%`;
        placeholder.style.top = `${s.position.top}%`;
    }

    function dragElement(elmnt, settingsKey) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;
        elmnt.ontouchstart = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            e = e.type === 'touchstart' ? e.touches[0] : e;
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.ontouchend = closeDragElement;
            document.onmousemove = elementDrag;
            document.ontouchmove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            e = e.type === 'touchmove' ? e.touches[0] : e;
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            
            const parentRect = DOMElements.positioningArea.getBoundingClientRect();
            const newTop = ((elmnt.offsetTop - pos2) / parentRect.height) * 100;
            const newLeft = ((elmnt.offsetLeft - pos1) / parentRect.width) * 100;
            
            settings[settingsKey].position.top = Math.max(0, Math.min(100 - (elmnt.offsetHeight / parentRect.height * 100), newTop));
            settings[settingsKey].position.left = Math.max(0, Math.min(100 - (elmnt.offsetWidth / parentRect.width * 100), newLeft));
            
            elmnt.style.top = settings[settingsKey].position.top + '%';
            elmnt.style.left = settings[settingsKey].position.left + '%';
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
        }
    }

    function saveAndContinue() {
        const currentLang = localStorage.getItem('language') || 'en';
        designs[currentSide] = JSON.parse(JSON.stringify(settings));
        localStorage.setItem('invitationDesigns', JSON.stringify(designs));
        showNotification(translations[currentLang].designSaved, 'green');
        setTimeout(() => { window.location.href = 'manager.html'; }, 1500);
    }
    
    function showNotification(message, type = 'green') {
        const notification = DOMElements.notification;
        if (!notification) return;

        clearTimeout(notificationTimeout);

        const colors = {
            green: 'bg-green-500',
            red: 'bg-red-500',
            yellow: 'bg-yellow-500'
        };
        
        notification.className = `fixed top-5 right-5 rtl:right-auto rtl:left-5 text-white py-3 px-6 rounded-lg shadow-xl transform transition-all duration-500 ease-in-out z-50 ${colors[type] || 'bg-gray-500'}`;
        notification.textContent = message;

        requestAnimationFrame(() => {
            notification.classList.remove('translate-x-full', 'rtl:-translate-x-full', 'opacity-0');
            notification.classList.add('translate-x-0', 'opacity-100');
        });

        notificationTimeout = setTimeout(() => {
            notification.classList.add('translate-x-full', 'rtl:-translate-x-full', 'opacity-0');
            notification.classList.remove('translate-x-0', 'opacity-100');
        }, 3000);
    }
    
    onAuthStateChanged(auth, (user) => { 
        if (user) { 
            document.body.style.display = 'block';
            const currentLang = localStorage.getItem('language') || 'en';
            setLanguage(currentLang);
            initializeEditor();
        } else { 
            window.location.href = 'login.html'; 
        } 
    });
</script>
</body>
</html>
