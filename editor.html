
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step 1: Design Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Dancing+Script:wght@700&family=Roboto:wght@700&family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background-color: #0f172a; /* Dark blue-slate background */
    background-image:
      radial-gradient(at 20% 25%, hsla(212,80%,30%,0.3) 0px, transparent 50%),
      radial-gradient(at 80% 20%, hsla(280,75%,40%,0.3) 0px, transparent 50%),
      radial-gradient(at 50% 80%, hsla(320,70%,50%,0.2) 0px, transparent 50%);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
  }
  .btn-primary {
    @apply font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 ease-in-out;
    background: linear-gradient(90deg, #6366F1, #8B5CF6);
    box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.5);
  }
  .btn-primary:hover:not(:disabled) {
    @apply shadow-2xl scale-105;
    box-shadow: 0 6px 20px 0 rgba(116, 79, 168, 0.65);
  }
  .btn-primary:disabled {
    background: #374151;
    box-shadow: none;
    transform: none;
    cursor: not-allowed;
    opacity: 0.6;
  }
  #positioning-area { touch-action: none; }
  .placeholder {
    position: absolute; cursor: move; user-select: none; font-weight: bold;
    display: flex; align-items: center; justify-content: center;
    box-sizing: border-box; border: 2px dashed rgba(255, 255, 255, 0.9);
    box-shadow: 0 0 15px rgba(0,0,0,0.5); top: 0; left: 0;
  }
  #image-drop-area { border: 2px dashed rgba(255, 255, 255, 0.2); }
  #image-drop-area.dragover { border-color: #8B5CF6; background-color: rgba(139, 92, 246, 0.1); }
</style>
</head>
<body class="text-gray-200">

<header class="bg-slate-900/50 backdrop-blur-lg border-b border-white/10 sticky top-0 z-20">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-100">Step 1: Design Your Card</h1>
    <a href="index.html" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors">&larr; Back to Hub</a>
  </div>
</header>

<main class="container mx-auto p-4 md:p-8 flex justify-center">
  <div class="w-full max-w-6xl">
    <!-- Uploader Section -->
    <div id="uploader-section" class="glass-card p-6 rounded-2xl">
      <h2 class="text-xl font-semibold text-gray-100 mb-2">1. Upload Invitation Design</h2>
      <p class="text-sm text-gray-400 mb-6">Drag & drop your image file or click to select. This will be the background for your card.</p>
      
      <div id="image-drop-area" class="relative flex flex-col items-center justify-center w-full h-64 rounded-lg cursor-pointer bg-white/5 hover:bg-white/10 transition-colors">
          <div class="flex flex-col items-center justify-center pt-5 pb-6">
              <svg class="w-10 h-10 mb-4 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
              <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
              <p class="text-xs text-gray-500">PNG, JPG or GIF</p>
          </div>
          <input type="file" id="imageUploader" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
      </div>
      
      <img id="imagePreview" class="mt-4 rounded-md hidden border-2 border-white/10 w-full" alt="Image Preview"/>
      
      <button id="uploadButton" class="mt-6 w-full btn-primary" disabled>
        Upload & Continue to Editor
      </button>
      
      <div id="uploadSpinner" class="hidden mt-4 text-center">
        <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-indigo-400" role="status"></div>
        <p class="text-sm text-gray-400 mt-2">Uploading to secure storage...</p>
      </div>
    </div>

    <!-- Editor Section -->
    <div id="editor-section" class="hidden">
      <div class="glass-card p-6 rounded-2xl">
        <h2 class="text-xl font-semibold text-gray-100 mb-2">2. Position & Style Guest Details</h2>
        <p class="text-sm text-gray-400 mb-6">Drag the placeholders to position them. Use the controls on the right to customize their appearance.</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div id="positioning-area" class="lg:col-span-2 relative inline-block select-none overflow-hidden rounded-lg border-2 border-white/10 bg-black">
            <img id="editor-image-preview" src="" class="max-w-full h-auto block opacity-80" alt="Invitation Preview"/>
            <div id="name-placeholder" class="placeholder" style="background-color: rgba(0, 0, 0, 0.5); color: white; padding: 5px 15px; border-radius: 6px; font-family: 'Roboto', sans-serif; font-size: 16px; transform: translate3d(20px, 20px, 0);">Guest Name</div>
            <div id="qr-placeholder" class="placeholder" style="background-color: rgba(255, 255, 255, 0.8); width: 100px; height: 100px; border-radius: 6px; transform: translate3d(20px, 80px, 0);"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-1/2 h-1/2 text-gray-800"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 013.75 9.375v-4.5zM3.75 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5zM13.5 4.875c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5A1.125 1.125 0 0113.5 9.375v-4.5zM13.5 14.625c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v4.5c0 .621-.504 1.125-1.125 1.125h-4.5a1.125 1.125 0 01-1.125-1.125v-4.5z" /></svg></div>
          </div>
          <div class="space-y-6">
              <div>
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2">Guest Name Style</h3>
                  <div class="space-y-4">
                      <div>
                          <label class="block text-sm font-medium text-gray-400 mb-1" for="font-color-picker">Font Color</label>
                          <input type="color" id="font-color-picker" value="#FFFFFF" class="p-1 h-10 w-full block bg-slate-800 border border-slate-600 cursor-pointer rounded-lg disabled:opacity-50 disabled:pointer-events-none">
                      </div>
                      <div>
                          <label class="block text-sm font-medium text-gray-400 mb-1" for="font-family-select">Font Family</label>
                          <select id="font-family-select" class="w-full p-2.5 bg-slate-800 border border-slate-600 rounded-lg text-gray-200 focus:ring-indigo-500 focus:border-indigo-500">
                              <option value="'Roboto', sans-serif" selected>Roboto (Modern)</option>
                              <option value="'Amiri', serif">Amiri (Elegant)</option>
                              <option value="'Dancing Script', cursive">Dancing Script (Cursive)</option>
                          </select>
                      </div>
                      <div>
                           <label class="block text-sm font-medium text-gray-400 mb-1">Font Size</label>
                           <input id="font-size-slider" type="range" min="8" max="72" value="16" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                      </div>
                  </div>
              </div>
              <div>
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2">QR Code Style</h3>
                   <div class="space-y-4">
                      <div>
                          <label class="block text-sm font-medium text-gray-400 mb-1">QR Code Size</label>
                          <input id="qr-size-slider" type="range" min="40" max="300" value="100" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                      </div>
                  </div>
              </div>
          </div>
        </div>
        <button id="save-positions-button" class="mt-8 w-full btn-primary">
          Save Design & Continue &rarr;
        </button>
      </div>
    </div>
  </div>
</main>

<div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-[120%] transition-transform duration-500 ease-in-out"></div>

<script type="module">
const imageUploader = document.getElementById('imageUploader');
const imagePreview = document.getElementById('imagePreview');
const uploadButton = document.getElementById('uploadButton');
const uploadSpinner = document.getElementById('uploadSpinner');
const imageDropArea = document.getElementById('image-drop-area');

const uploaderSection = document.getElementById('uploader-section');
const editorSection = document.getElementById('editor-section');
const editorImagePreview = document.getElementById('editor-image-preview');
const savePositionsButton = document.getElementById('save-positions-button');

let selectedFile = null;
let cardImageUrl = '';

const IMGBB_API_KEY = '97c60166127ae9258012f463e09b1e2d';

// --- DRAG & DROP UPLOAD LOGIC ---
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  imageDropArea.addEventListener(eventName, preventDefaults, false)
});
function preventDefaults (e) {
  e.preventDefault();
  e.stopPropagation();
}
['dragenter', 'dragover'].forEach(eventName => {
  imageDropArea.addEventListener(eventName, () => imageDropArea.classList.add('dragover'), false);
});
['dragleave', 'drop'].forEach(eventName => {
  imageDropArea.addEventListener(eventName, () => imageDropArea.classList.remove('dragover'), false);
});
imageDropArea.addEventListener('drop', (e) => {
    handleFile(e.dataTransfer.files[0]);
}, false);
imageUploader.addEventListener('change', (e) => handleFile(e.target.files[0]));

function handleFile(file) {
    if (!file || !file.type.startsWith('image/')) return;
    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (event) => {
        imagePreview.src = event.target.result;
        imagePreview.classList.remove('hidden');
    };
    reader.readAsDataURL(selectedFile);
    uploadButton.disabled = false;
}

uploadButton.addEventListener('click', async () => {
    if (!selectedFile) {
        showNotification('Please select an image first', 'yellow');
        return;
    }
    
    uploadButton.disabled = true;
    uploadSpinner.classList.remove('hidden');

    const formData = new FormData();
    formData.append('image', selectedFile);

    try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
            method: 'POST',
            body: formData,
        });
        const result = await response.json();
        if (result.success) {
            cardImageUrl = result.data.url;
            showNotification('Upload successful! Now, design your card.', 'green');
            editorImagePreview.src = cardImageUrl;
            uploaderSection.classList.add('hidden');
            editorSection.classList.remove('hidden');
        } else {
            throw new Error(result.error?.message || 'Unknown error uploading to imgbb');
        }
    } catch (error) {
        console.error("Upload failed:", error);
        showNotification(`Image upload failed: ${error.message}`, 'red');
        uploadButton.disabled = false;
    } finally {
        uploadSpinner.classList.add('hidden');
    }
});

// --- EDITOR LOGIC ---
const positioningArea = document.getElementById('positioning-area');
const namePlaceholder = document.getElementById('name-placeholder');
const qrPlaceholder = document.getElementById('qr-placeholder');

const colorPicker = document.getElementById('font-color-picker');
const fontFamilySelect = document.getElementById('font-family-select');
const fontSizeSlider = document.getElementById('font-size-slider');
const qrSizeSlider = document.getElementById('qr-size-slider');

colorPicker.addEventListener('input', (e) => namePlaceholder.style.color = e.target.value);
fontFamilySelect.addEventListener('change', (e) => namePlaceholder.style.fontFamily = e.target.value);
fontSizeSlider.addEventListener('input', (e) => namePlaceholder.style.fontSize = `${e.target.value}px`);
qrSizeSlider.addEventListener('input', (e) => {
    qrPlaceholder.style.width = `${e.target.value}px`;
    qrPlaceholder.style.height = `${e.target.value}px`;
});

// --- Drag and Drop Logic ---
function makeDraggable(element) {
  let active = false;
  let currentX, currentY, initialX, initialY;
  const transform = new DOMMatrix(getComputedStyle(element).transform);
  let xOffset = transform.e;
  let yOffset = transform.f;

  const dragStart = (e) => {
    initialX = e.type === 'touchstart' ? e.touches[0].clientX - xOffset : e.clientX - xOffset;
    initialY = e.type === 'touchstart' ? e.touches[0].clientY - yOffset : e.clientY - yOffset;
    if (e.target === element || element.contains(e.target)) {
      active = true;
      element.style.zIndex = 10;
    }
  };
  const dragEnd = () => { active = false; element.style.zIndex = 1; };
  const drag = (e) => {
    if (active) {
      e.preventDefault();
      currentX = e.type === 'touchmove' ? e.touches[0].clientX - initialX : e.clientX - initialX;
      currentY = e.type === 'touchmove' ? e.touches[0].clientY - initialY : e.clientY - initialY;
      
      const parentRect = positioningArea.getBoundingClientRect();
      const elemRect = element.getBoundingClientRect();
      let newLeft = Math.max(0, Math.min(currentX, parentRect.width - elemRect.width));
      let newTop = Math.max(0, Math.min(currentY, parentRect.height - elemRect.height));

      xOffset = newLeft;
      yOffset = newTop;
      element.style.transform = `translate3d(${xOffset}px, ${yOffset}px, 0)`;
    }
  };
  ['touchstart', 'mousedown'].forEach(evt => positioningArea.addEventListener(evt, dragStart, false));
  ['touchend', 'mouseup', 'mouseleave'].forEach(evt => positioningArea.addEventListener(evt, dragEnd, false));
  ['touchmove', 'mousemove'].forEach(evt => positioningArea.addEventListener(evt, drag, false));
}
makeDraggable(namePlaceholder);
makeDraggable(qrPlaceholder);

// --- Save Positions & Styles Logic ---
savePositionsButton.addEventListener('click', () => {
    const areaRect = positioningArea.getBoundingClientRect();
    const getElementData = (element) => {
        const transform = new DOMMatrix(getComputedStyle(element).transform);
        const style = getComputedStyle(element);
        return {
            x: transform.e / areaRect.width,
            y: transform.f / areaRect.height,
            width: parseFloat(style.width) / areaRect.width,
            height: parseFloat(style.height) / areaRect.height,
            color: style.color,
            fontFamily: style.fontFamily,
            fontSize: parseFloat(style.fontSize) / areaRect.height
        };
    };
    const nameData = getElementData(namePlaceholder);
    const qrData = getElementData(qrPlaceholder);
    const cardTemplate = {
        imageUrl: cardImageUrl,
        nameSettings: { x: nameData.x, y: nameData.y, color: nameData.color, fontFamily: nameData.fontFamily, fontSize: nameData.fontSize },
        qrSettings: { x: qrData.x, y: qrData.y, size: qrData.width },
    };
    localStorage.setItem('cardTemplate', JSON.stringify(cardTemplate));
    showNotification('Design saved! Redirecting...', 'green');
    setTimeout(() => window.location.href = 'manager.html', 1500);
});

// --- Utility Functions ---
function showNotification(message, type = 'green') {
    const notification = document.getElementById('notification');
    const colors = { green: 'bg-green-500', red: 'bg-red-500', yellow: 'bg-yellow-500' };
    notification.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transition-transform duration-500 ease-in-out ${colors[type] || 'bg-gray-500'} transform translate-x-[120%]`;
    notification.textContent = message;
    notification.style.transform = 'translateX(0)';
    setTimeout(() => notification.style.transform = 'translateX(120%)', 3000);
}
</script>
</body>
</html>
