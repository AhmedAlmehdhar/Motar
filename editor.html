
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Step 1: Design Card</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Dancing+Script:wght@700&family=Roboto:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
<style>
  :root { --font-main: 'Plus Jakarta Sans', sans-serif; }
  html[lang="ar"] { --font-main: 'Cairo', sans-serif; }
  body {
    font-family: var(--font-main);
    background-color: #0f172a;
    background-image:
      radial-gradient(at 20% 25%, hsla(212,80%,30%,0.3) 0px, transparent 50%),
      radial-gradient(at 80% 20%, hsla(280,75%,40%,0.3) 0px, transparent 50%),
      radial-gradient(at 50% 80%, hsla(320,70%,50%,0.2) 0px, transparent 50%);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
  }
  .btn-primary {
    @apply font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 ease-in-out;
    background: linear-gradient(90deg, #6366F1, #8B5CF6);
    box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.5);
  }
  .btn-primary:hover:not(:disabled) {
    @apply shadow-2xl scale-105;
    box-shadow: 0 6px 20px 0 rgba(116, 79, 168, 0.65);
  }
  .btn-primary:disabled { background: #374151; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.6; }
  #positioning-area { touch-action: none; }
  .placeholder {
    position: absolute; cursor: move; user-select: none; top: 0; left: 0;
    display: flex; align-items: center; justify-content: center;
    border: 2px dashed rgba(255, 255, 255, 0.7);
  }
  #qr-placeholder-img { max-width: 100%; height: auto; }
  #image-drop-area { border: 2px dashed rgba(255, 255, 255, 0.2); }
  #image-drop-area.dragover { border-color: #8B5CF6; background-color: rgba(139, 92, 246, 0.1); }
  input[type="range"]::-webkit-slider-thumb { @apply bg-indigo-400; }
  input[type="range"]::-moz-range-thumb { @apply bg-indigo-400; }
  #eyedropper-overlay { position: fixed; inset: 0; cursor: crosshair; z-index: 100; }
  #magnifier { position: absolute; width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5); background-color: white; background-repeat: no-repeat; pointer-events: none; transform: translate(-50%, -50%); overflow: hidden; }
  #magnifier::after { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; border: 2px solid black; border-radius: 50%; }
</style>
</head>
<body class="text-gray-200" style="display: none;">

<header class="bg-slate-900/50 backdrop-blur-lg border-b border-white/10 sticky top-0 z-20">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 id="header-title" class="text-xl font-bold text-gray-100" data-lang-key="headerTitle">Design Card</h1>
    <div class="flex items-center gap-4">
        <a href="index.html" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors" data-lang-key="backToHub">&larr; Back to Hub</a>
        <button id="lang-switcher" class="font-bold text-sm border border-white/20 rounded-md px-3 py-1.5 hover:bg-white/10 transition-colors">AR</button>
        <button id="logout-button" class="font-bold text-sm bg-red-600/50 border border-red-500/30 text-red-300 rounded-md px-3 py-1.5 hover:bg-red-600/70 transition-colors" data-lang-key="logout">Logout</button>
    </div>
  </div>
</header>

<main class="container mx-auto p-4 md:p-8 flex justify-center">
  <div class="w-full max-w-7xl">
    <div id="uploader-section" class="glass-card p-6 rounded-2xl">
      <div id="uploader-interface">
        <h2 class="text-xl font-semibold text-gray-100 mb-2" data-lang-key="uploadTitle">1. Upload Invitation Design</h2>
        <p class="text-sm text-gray-400 mb-6" data-lang-key="uploadDesc">Drag & drop your image file or click to select. This will be the background for your card.</p>
        <div id="image-drop-area" class="relative flex flex-col items-center justify-center w-full h-64 rounded-lg cursor-pointer bg-white/5 hover:bg-white/10 transition-colors">
            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <svg class="w-10 h-10 mb-4 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                <p class="mb-2 text-sm text-gray-400"><span class="font-semibold" data-lang-key="clickToUpload">Click to upload</span><span data-lang-key="orDragDrop"> or drag and drop</span></p>
                <p class="text-xs text-gray-500">PNG, JPG or GIF</p>
            </div>
            <input type="file" id="imageUploader" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
        </div>
        <p class="text-center mt-4 text-gray-400 text-sm">
              <span data-lang-key="orUseTemplate">Don't have a design?</span>
              <a id="templates-link" href="templates.html" class="font-semibold text-indigo-400 hover:text-indigo-300" data-lang-key="chooseTemplateLink">
                  Choose one of our templates
              </a>
          </p>
        <img id="imagePreview" class="mt-4 rounded-md hidden border-2 border-white/10 w-full" alt="Image Preview"/>
        <button id="uploadButton" class="mt-6 w-full btn-primary" data-lang-key="uploadBtn" disabled>Upload & Continue to Editor</button>
        <div id="uploadSpinner" class="hidden mt-4 text-center"><div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-indigo-400" role="status"></div><p class="text-sm text-gray-400 mt-2" data-lang-key="uploading">Uploading to secure storage...</p></div>
      </div>
      <div id="active-card-section" class="hidden text-center">
        <h2 class="text-xl font-semibold text-gray-100 mb-4" data-lang-key="activeCardTitle">Your Active Design</h2>
        <img id="activeCardPreview" class="rounded-lg border-2 border-white/10 max-w-md mx-auto" alt="Active Card Preview"/>
        <p class="text-sm text-gray-400 mt-4" data-lang-key="activeCardDesc">You can continue editing your saved design or start over with a new one.</p>
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-md mx-auto">
            <button id="edit-card-button" class="w-full btn-primary" data-lang-key="editCardBtn">Edit Design</button>
            <button id="remove-card-button" class="w-full font-bold py-3 px-6 rounded-lg text-red-300 bg-red-900/50 hover:bg-red-800/50 border border-red-500/30 transition-colors" data-lang-key="removeCardBtn">Remove & Start Over</button>
        </div>
    </div>
    </div>

    <div id="editor-section" class="hidden">
      <div class="glass-card p-6 rounded-2xl">
        <h2 class="text-xl font-semibold text-gray-100 mb-2" data-lang-key="editorTitle">2. Position & Style Guest Details</h2>
        <p class="text-sm text-gray-400 mb-6" data-lang-key="editorDesc">Drag the placeholders to position them. Use the controls on the right to customize their appearance.</p>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div id="positioning-area" class="lg:col-span-2 relative inline-block select-none overflow-hidden rounded-lg border-2 border-white/10 bg-black">
            <img id="editor-image-preview" src="" crossorigin="anonymous" class="max-w-full h-auto block opacity-80" alt="Invitation Preview"/>
            <div id="name-placeholder" class="placeholder p-2 font-bold" style="color: white; font-family: 'Roboto', sans-serif;" data-lang-key="guestName">Guest Name</div>
            <div id="qr-placeholder" class="placeholder"><img id="qr-placeholder-img" src="" alt="QR Code Preview"/></div>
             <div id="size-controls" class="hidden absolute z-20 bg-slate-900/70 backdrop-blur-sm rounded-md shadow-lg p-1 flex items-center gap-1">
                <button id="decrease-size-btn" class="w-7 h-7 bg-slate-700 hover:bg-slate-600 rounded text-lg font-bold">-</button>
                <span id="current-size-label" class="text-xs font-mono w-10 text-center"></span>
                <button id="increase-size-btn" class="w-7 h-7 bg-slate-700 hover:bg-slate-600 rounded text-lg font-bold">+</button>
            </div>
          </div>
          <div class="space-y-4">
              <div class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="nameStyleTitle">Guest Name Customization</h3>
                  <div class="grid grid-cols-2 gap-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-400" data-lang-key="fontColor">Font Color</label>
                        <div class="flex items-center mt-1 bg-slate-800 border border-slate-600 rounded-lg p-1 w-max">
                            <div id="font-color-display" class="w-8 h-8 rounded-md border border-slate-500"></div>
                            <button id="font-color-eyedropper" class="p-1 ml-1 hover:bg-slate-700 rounded-md"><span class="material-symbols-outlined text-lg">colorize</span></button>
                        </div>
                        <input type="hidden" id="font-color-picker">
                      </div>
                      <div><label class="block text-sm font-medium text-gray-400" data-lang-key="fontFamily">Font Family</label><select id="font-family-select" class="w-full p-2 bg-slate-800 border border-slate-600 rounded-lg text-gray-200"><option value="'Roboto', sans-serif">Roboto</option><option value="'Amiri', serif">Amiri</option><option value="'Dancing Script', cursive">Dancing Script</option></select></div>
                      <div class="col-span-2"><label class="block text-sm font-medium text-gray-400" data-lang-key="fontSize">Font Size</label><input id="font-size-slider" type="range" min="8" max="100" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer"></div>
                      <div class="col-span-2"><label class="block text-sm font-medium text-gray-400" data-lang-key="rotation">Rotation</label><input id="font-rotation-slider" type="range" min="-45" max="45" value="0" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer"></div>
                      <div class="col-span-2 flex gap-4"><div class="flex items-center"><input type="checkbox" id="font-bold-toggle" class="h-4 w-4 rounded bg-slate-700 border-slate-500"><label for="font-bold-toggle" class="ms-2 text-sm text-gray-300" data-lang-key="bold">Bold</label></div><div class="flex items-center"><input type="checkbox" id="font-italic-toggle" class="h-4 w-4 rounded bg-slate-700 border-slate-500"><label for="font-italic-toggle" class="ms-2 text-sm text-gray-300" data-lang-key="italic">Italic</label></div></div>
                      <div class="col-span-2 border-t border-white/10 pt-3"><label class="flex items-center"><input type="checkbox" id="shadow-toggle" class="h-4 w-4 rounded"><span class="ms-2 text-sm font-medium text-gray-300" data-lang-key="textShadow">Text Shadow</span></label></div>
                      <div id="shadow-controls" class="hidden col-span-2 grid grid-cols-2 gap-4">
                          <div>
                            <label class="text-xs text-gray-400">Color</label>
                            <div class="flex items-center mt-1 bg-slate-700 border border-slate-600 rounded p-0.5 w-max">
                                <div id="shadow-color-display" class="w-6 h-6 rounded-sm border border-slate-500"></div>
                                <button id="shadow-color-eyedropper" class="p-0.5 ml-1 hover:bg-slate-600 rounded-md"><span class="material-symbols-outlined text-base">colorize</span></button>
                            </div>
                            <input type="hidden" id="shadow-color-picker">
                          </div>
                          <div><label class="text-xs text-gray-400">Blur</label><input type="range" id="shadow-blur-slider" min="0" max="20" class="w-full"></div>
                          <div><label class="text-xs text-gray-400">Offset X</label><input type="range" id="shadow-offset-x-slider" min="-10" max="10" class="w-full"></div>
                          <div><label class="text-xs text-gray-400">Offset Y</label><input type="range" id="shadow-offset-y-slider" min="-10" max="10" class="w-full"></div>
                      </div>
                      <div class="col-span-2 border-t border-white/10 pt-3"><label class="flex items-center"><input type="checkbox" id="stroke-toggle" class="h-4 w-4 rounded"><span class="ms-2 text-sm font-medium text-gray-300" data-lang-key="textStroke">Text Stroke</span></label></div>
                      <div id="stroke-controls" class="hidden col-span-2 grid grid-cols-2 gap-4">
                          <div>
                            <label class="text-xs text-gray-400">Color</label>
                            <div class="flex items-center mt-1 bg-slate-700 border border-slate-600 rounded p-0.5 w-max">
                                <div id="stroke-color-display" class="w-6 h-6 rounded-sm border border-slate-500"></div>
                                <button id="stroke-color-eyedropper" class="p-0.5 ml-1 hover:bg-slate-600 rounded-md"><span class="material-symbols-outlined text-base">colorize</span></button>
                            </div>
                            <input type="hidden" id="stroke-color-picker">
                          </div>
                          <div><label class="text-xs text-gray-400">Width</label><input type="range" id="stroke-width-slider" min="0" max="5" step="0.5" class="w-full"></div>
                      </div>
                  </div>
              </div>
              <div class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="qrStyleTitle">QR Code Customization</h3>
                  <div class="grid grid-cols-2 gap-4">
                      <div class="col-span-2"><label class="block text-sm font-medium text-gray-400" data-lang-key="qrSize">Size</label><input id="qr-size-slider" type="range" min="40" max="400" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer"></div>
                      <div>
                        <label class="text-sm text-gray-400">Modules</label>
                        <div class="flex items-center mt-1 bg-slate-800 border border-slate-600 rounded-lg p-1 w-max">
                            <div id="qr-color-dark-display" class="w-8 h-8 rounded-md border border-slate-500"></div>
                            <button id="qr-color-dark-eyedropper" class="p-1 ml-1 hover:bg-slate-700 rounded-md"><span class="material-symbols-outlined text-lg">colorize</span></button>
                        </div>
                        <input type="hidden" id="qr-color-dark-picker">
                      </div>
                      <div>
                        <label class="text-sm text-gray-400">Background</label>
                        <div class="flex items-center mt-1 bg-slate-800 border border-slate-600 rounded-lg p-1 w-max">
                            <div id="qr-color-light-display" class="w-8 h-8 rounded-md border border-slate-500"></div>
                            <button id="qr-color-light-eyedropper" class="p-1 ml-1 hover:bg-slate-700 rounded-md"><span class="material-symbols-outlined text-lg">colorize</span></button>
                        </div>
                        <input type="hidden" id="qr-color-light-picker">
                      </div>
                      <div class="col-span-2"><label class="block text-sm text-gray-400" data-lang-key="qrLogo">Center Logo</label><input type="file" id="qr-logo-uploader" accept="image/png, image/jpeg" class="text-xs file:mr-2 file:py-1 file:px-2 file:rounded-md file:border-0 file:bg-indigo-500 file:text-white hover:file:bg-indigo-600"></div>
                  </div>
              </div>
          </div>
        </div>
        <button id="save-positions-button" class="mt-8 w-full btn-primary" data-lang-key="saveBtn">Save Design & Continue &rarr;</button>
      </div>
    </div>
  </div>
</main>
<div id="notification" class="fixed top-5 right-5 z-50 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-[120%] transition-transform duration-500 ease-in-out"></div>
<div id="eyedropper-overlay" class="hidden"><div id="magnifier"></div></div>
<div id="eyedropper-instruction" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[101] hidden items-center gap-3 rounded-lg bg-slate-900/70 px-4 py-3 text-white shadow-lg backdrop-blur-sm transition-all duration-300 border border-slate-700">
    <span class="material-symbols-outlined">ads_click</span>
    <p data-lang-key="eyedropperInstruction"></p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
    import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm';

    const firebaseConfig = { apiKey: "AIzaSyCuZVUBIA0oDQuPzRUQbMJCJZK32zmVaVQ", authDomain: "final-draft-8f39d.firebaseapp.com", databaseURL: "https://final-draft-8f39d-default-rtdb.firebaseio.com", projectId: "final-draft-8f39d", storageBucket: "final-draft-8f39d.appspot.com", messagingSenderId: "994437210054", appId: "1:994437210054:web:628c741b81ccf741175cc7" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);
    let currentUser = null;
    let side = '';

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            document.body.style.display = 'block';
            initializePage();
        } else {
            window.location.href = 'login.html';
        }
    });

    function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        side = urlParams.get('side');
        if (!side) {
            alert('No side specified!');
            window.location.href = 'index.html';
            return;
        }
        document.getElementById('templates-link').href = `templates.html?side=${side}`;
        loadInitialDesign();
    }

    document.getElementById('logout-button').addEventListener('click', () => {
        signOut(auth);
    });
    
    const translations = {
        en: { headerTitle: "Design Your Card", headerTitleGroom: "Design Groom's Card", headerTitleBride: "Design Bride's Card", backToHub: "← Back to Hub", uploadTitle: "1. Upload Invitation Design", uploadDesc: "Drag & drop your image file or click to select. This will be the background for your card.", clickToUpload: "Click to upload", orDragDrop: " or drag and drop", orUseTemplate: "Don't have a design?", chooseTemplateLink: "Choose one of our templates", uploadBtn: "Upload & Continue to Editor", uploading: "Uploading to secure storage...", editorTitle: "2. Position & Style Guest Details", editorDesc: "Drag the placeholders to position them. Use the controls on the right to customize their appearance.", guestName: "Guest Name", nameStyleTitle: "Guest Name Customization", fontColor: "Font Color", fontFamily: "Font Family", fontSize: "Font Size", rotation: "Rotation", bold: "Bold", italic: "Italic", textShadow: "Text Shadow", textStroke: "Text Stroke", qrStyleTitle: "QR Code Customization", qrSize: "Size", qrLogo: "Center Logo", saveBtn: "Save Design & Continue →", selectImageFirst: "Please select an image first", uploadSuccess: "Upload successful! Now, design your card.", uploadFailed: "Image upload failed: ", designSaved: "Design saved! Redirecting...", designSaveError: "Error saving design: ", logout: "Logout", templateLoaded: "Template loaded and saved! You can now edit it.", designLoaded: "Saved design loaded.", eyedropperFail: "Could not start color picker.", eyedropperInstruction: "Click anywhere on the design to pick a color.", activeCardTitle: "Your Active Design", activeCardDesc: "You can continue editing your saved design or start over with a new one.", editCardBtn: "Edit Design", removeCardBtn: "Remove & Start Over", designRemoved: "Design removed. You can now upload a new one." },
        ar: { headerTitle: "تصميم بطاقتك", headerTitleGroom: "تصميم بطاقة العريس", headerTitleBride: "تصميم بطاقة العروس", backToHub: "→ العودة للمركز", uploadTitle: "١. رفع تصميم الدعوة", uploadDesc: "اسحب وأفلت ملف الصورة أو انقر للاختيار. ستكون هذه هي خلفية بطاقتك.", clickToUpload: "انقر للرفع", orDragDrop: " أو اسحب وأفلت", orUseTemplate: "ليس لديك تصميم؟", chooseTemplateLink: "اختر أحد قوالبنا", uploadBtn: "رفع ومتابعة إلى المحرر", uploading: "جاري الرفع إلى التخزين الآمن...", editorTitle: "٢. تحديد أماكن وتنسيق تفاصيل الضيف", editorDesc: "اسحب العناصر لتحديد أماكنها. استخدم عناصر التحكم على اليسار لتخصيص مظهرها.", guestName: "اسم الضيف", nameStyleTitle: "تخصيص اسم الضيف", fontColor: "لون الخط", fontFamily: "نوع الخط", fontSize: "حجم الخط", rotation: "دوران", bold: "عريض", italic: "مائل", textShadow: "ظل النص", textStroke: "إطار النص", qrStyleTitle: "تخصيص رمز QR", qrSize: "الحجم", qrLogo: "شعار في المنتصف", saveBtn: "حفظ التصميم والمتابعة ←", selectImageFirst: "الرجاء اختيار صورة أولاً", uploadSuccess: "تم الرفع بنجاح! الآن، قم بتصميم بطاقتك.", uploadFailed: "فشل رفع الصورة: ", designSaved: "تم حفظ التصميم! جارٍ إعادة التوجيه...", designSaveError: "خطأ في حفظ التصميم: ", logout: "تسجيل الخروج", templateLoaded: "تم تحميل القالب وحفظه! يمكنك الآن تعديله.", designLoaded: "تم تحميل التصميم المحفوظ.", eyedropperFail: "تعذر بدء منتقي الألوان.", eyedropperInstruction: "انقر في أي مكان على التصميم لاختيار لون.", activeCardTitle: "تصميمك الحالي", activeCardDesc: "يمكنك متابعة تعديل تصميمك المحفوظ أو البدء من جديد.", editCardBtn: "تعديل التصميم", removeCardBtn: "إزالة والبدء من جديد", designRemoved: "تمت إزالة التصميم. يمكنك الآن رفع تصميم جديد." }
    };
    const langSwitcher = document.getElementById('lang-switcher');
    let currentLang = localStorage.getItem('language') || 'en';
    const setLanguage = (lang) => { localStorage.setItem('language', lang); currentLang = lang; document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; langSwitcher.textContent = lang === 'ar' ? 'EN' : 'AR'; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (translations[lang][key]) { if (key === 'orDragDrop') { el.previousElementSibling.textContent = translations[lang]['clickToUpload']; el.textContent = translations[lang]['orDragDrop']; } else if(key === 'chooseTemplateLink') { el.previousElementSibling.textContent = translations[lang]['orUseTemplate'] + ' '; el.textContent = translations[lang]['chooseTemplateLink']; } else { el.textContent = translations[lang][key]; } } }); const headerTitleKey = side === 'groom' ? 'headerTitleGroom' : 'headerTitleBride'; document.getElementById('header-title').textContent = translations[lang][headerTitleKey] || translations[lang].headerTitle; document.title = translations[lang][headerTitleKey] || translations[lang].headerTitle; const namePlaceholder = document.getElementById('name-placeholder'); if (namePlaceholder) { namePlaceholder.textContent = translations[lang].guestName; } };
    langSwitcher.addEventListener('click', () => setLanguage(currentLang === 'en' ? 'ar' : 'en'));
    
    const IMGBB_API_KEY = '97c60166127ae9258012f463e09b1e2d';
    const DOMElements = { uploaderSection: document.getElementById('uploader-section'), editorSection: document.getElementById('editor-section'), imageUploader: document.getElementById('imageUploader'), imagePreview: document.getElementById('imagePreview'), uploadButton: document.getElementById('uploadButton'), uploadSpinner: document.getElementById('uploadSpinner'), imageDropArea: document.getElementById('image-drop-area'), editorImagePreview: document.getElementById('editor-image-preview'), positioningArea: document.getElementById('positioning-area'), namePlaceholder: document.getElementById('name-placeholder'), qrPlaceholder: document.getElementById('qr-placeholder'), qrPlaceholderImg: document.getElementById('qr-placeholder-img'), savePositionsButton: document.getElementById('save-positions-button'), notification: document.getElementById('notification'), eyedropperOverlay: document.getElementById('eyedropper-overlay'), magnifier: document.getElementById('magnifier'), eyedropperInstruction: document.getElementById('eyedropper-instruction'), sizeControls: document.getElementById('size-controls'), decreaseSizeBtn: document.getElementById('decrease-size-btn'), increaseSizeBtn: document.getElementById('increase-size-btn'), currentSizeLabel: document.getElementById('current-size-label'), uploaderInterface: document.getElementById('uploader-interface'), activeCardSection: document.getElementById('active-card-section'), activeCardPreview: document.getElementById('activeCardPreview'), editCardButton: document.getElementById('edit-card-button'), removeCardButton: document.getElementById('remove-card-button') };
    const controls = { color: document.getElementById('font-color-picker'), colorDisplay: document.getElementById('font-color-display'), colorEyedropper: document.getElementById('font-color-eyedropper'), family: document.getElementById('font-family-select'), size: document.getElementById('font-size-slider'), rotation: document.getElementById('font-rotation-slider'), bold: document.getElementById('font-bold-toggle'), italic: document.getElementById('font-italic-toggle'), shadow: document.getElementById('shadow-toggle'), shadowControls: document.getElementById('shadow-controls'), shadowColor: document.getElementById('shadow-color-picker'), shadowColorDisplay: document.getElementById('shadow-color-display'), shadowColorEyedropper: document.getElementById('shadow-color-eyedropper'), shadowBlur: document.getElementById('shadow-blur-slider'), shadowX: document.getElementById('shadow-offset-x-slider'), shadowY: document.getElementById('shadow-offset-y-slider'), stroke: document.getElementById('stroke-toggle'), strokeControls: document.getElementById('stroke-controls'), strokeColor: document.getElementById('stroke-color-picker'), strokeColorDisplay: document.getElementById('stroke-color-display'), strokeColorEyedropper: document.getElementById('stroke-color-eyedropper'), strokeWidth: document.getElementById('stroke-width-slider'), qrSize: document.getElementById('qr-size-slider'), qrColorDark: document.getElementById('qr-color-dark-picker'), qrColorDarkDisplay: document.getElementById('qr-color-dark-display'), qrColorDarkEyedropper: document.getElementById('qr-color-dark-eyedropper'), qrColorLight: document.getElementById('qr-color-light-picker'), qrColorLightDisplay: document.getElementById('qr-color-light-display'), qrColorLightEyedropper: document.getElementById('qr-color-light-eyedropper'), qrLogo: document.getElementById('qr-logo-uploader'), };
    let selectedFile = null, cardImageUrl = '', qrLogoUrl = '', selectedPlaceholder = null;
    const defaultSettings = { name: { x: 20, y: 20, color: '#FFFFFF', family: "'Roboto', sans-serif", size: 40, rotation: 0, bold: false, italic: false, shadow: { enabled: false, color: '#000000', blur: 0, x: 0, y: 0 }, stroke: { enabled: false, color: '#000000', width: 1 } }, qr: { x: 20, y: 80, size: 100, colorDark: '#000000', colorLight: '#FFFFFF', logoUrl: '' } };
    let settings = JSON.parse(JSON.stringify(defaultSettings));

    const showNotification = (messageKey, type = 'green', isKey = true) => { const message = isKey ? translations[currentLang][messageKey] : messageKey; const colors = { green: 'bg-emerald-500/90 border border-emerald-400/50', red: 'bg-rose-500/90 border border-rose-400/50', yellow: 'bg-amber-400/90 border border-amber-300/50' }; DOMElements.notification.className = `fixed top-5 right-5 z-50 text-white py-3 px-6 rounded-lg shadow-xl transition-transform duration-500 ease-in-out ${colors[type] || 'bg-gray-500'} transform translate-x-[120%]`; DOMElements.notification.textContent = message; DOMElements.notification.style.transform = 'translateX(0)'; setTimeout(() => DOMElements.notification.style.transform = 'translateX(120%)', 3000); };
    
    function makeDraggable(element, settingObj) { let active = false, initialX, initialY; const dragStart = (e) => { if (e.target === element || element.contains(e.target)) { toggleSizeControls(element); active = true; element.style.zIndex = 10; initialX = e.type === 'touchstart' ? e.touches[0].clientX - settingObj.x : e.clientX - settingObj.x; initialY = e.type === 'touchstart' ? e.touches[0].clientY - settingObj.y : e.clientY - settingObj.y; } }; const dragEnd = () => { active = false; element.style.zIndex = 1; }; const drag = (e) => { if (active) { e.preventDefault(); const currentX = e.type === 'touchmove' ? e.touches[0].clientX - initialX : e.clientX - initialX; const currentY = e.type === 'touchmove' ? e.touches[0].clientY - initialY : e.clientY - initialY; const parentRect = DOMElements.positioningArea.getBoundingClientRect(); const elemRect = element.getBoundingClientRect(); settingObj.x = Math.max(0, Math.min(currentX, parentRect.width - elemRect.width)); settingObj.y = Math.max(0, Math.min(currentY, parentRect.height - elemRect.height)); updatePlaceholders().then(() => { if (element === selectedPlaceholder) updateSizeControlsPosition(); }); } }; ['touchstart', 'mousedown'].forEach(evt => DOMElements.positioningArea.addEventListener(evt, dragStart, false)); ['touchend', 'mouseup', 'mouseleave'].forEach(evt => DOMElements.positioningArea.addEventListener(evt, dragEnd, false)); ['touchmove', 'mousemove'].forEach(evt => DOMElements.positioningArea.addEventListener(evt, drag, false)); }

    function initializeEditorInteractivity() {
        makeDraggable(DOMElements.namePlaceholder, settings.name);
        makeDraggable(DOMElements.qrPlaceholder, settings.qr);
    }
    
    function updateSizeControlsPosition() { if (!selectedPlaceholder) return; const placeholderRect = selectedPlaceholder.getBoundingClientRect(); const areaRect = DOMElements.positioningArea.getBoundingClientRect(); let top = placeholderRect.top - areaRect.top - DOMElements.sizeControls.offsetHeight - 5; if (top < 5) { top = placeholderRect.bottom - areaRect.top + 5; } DOMElements.sizeControls.style.left = `${placeholderRect.left - areaRect.left + (placeholderRect.width / 2) - (DOMElements.sizeControls.offsetWidth / 2)}px`; DOMElements.sizeControls.style.top = `${top}px`; if (selectedPlaceholder.id === 'name-placeholder') { DOMElements.currentSizeLabel.textContent = settings.name.size; } else if (selectedPlaceholder.id === 'qr-placeholder') { DOMElements.currentSizeLabel.textContent = settings.qr.size; } }
    function toggleSizeControls(element) { if (selectedPlaceholder === element) { return; } if (element) { selectedPlaceholder = element; DOMElements.sizeControls.classList.remove('hidden'); updateSizeControlsPosition(); } else { selectedPlaceholder = null; DOMElements.sizeControls.classList.add('hidden'); } }
    function changeSize(delta) { if (!selectedPlaceholder) return; const step = selectedPlaceholder.id === 'name-placeholder' ? 2 : 5; if (selectedPlaceholder.id === 'name-placeholder') { let newSize = parseInt(settings.name.size) + (delta * step); newSize = Math.max(8, Math.min(100, newSize)); settings.name.size = newSize; controls.size.value = newSize; } else if (selectedPlaceholder.id === 'qr-placeholder') { let newSize = parseInt(settings.qr.size) + (delta * step); newSize = Math.max(40, Math.min(400, newSize)); settings.qr.size = newSize; controls.qrSize.value = newSize; } updatePlaceholders().then(() => { updateSizeControlsPosition(); }); }

    const updatePlaceholders = async () => { const s = settings.name; const np = DOMElements.namePlaceholder; np.style.color = s.color; np.style.fontFamily = s.family; np.style.fontSize = `${s.size}px`; np.style.fontWeight = s.bold ? 'bold' : 'normal'; np.style.fontStyle = s.italic ? 'italic' : 'normal'; np.style.transform = `translate3d(${s.x}px, ${s.y}px, 0) rotate(${s.rotation}deg)`; np.style.textShadow = s.shadow.enabled ? `${s.shadow.x}px ${s.shadow.y}px ${s.shadow.blur}px ${s.shadow.color}` : 'none'; np.style.webkitTextStroke = s.stroke.enabled ? `${s.stroke.width}px ${s.stroke.color}` : 'unset'; const q = settings.qr; const qp = DOMElements.qrPlaceholder; qp.style.width = `${q.size}px`; qp.style.height = `${q.size}px`; qp.style.transform = `translate3d(${q.x}px, ${q.y}px, 0)`; const qrDataUrl = await QRCode.toDataURL('PREVIEW', { width: 400, margin: 1, errorCorrectionLevel: 'H', color: { dark: q.colorDark, light: q.colorLight } }); DOMElements.qrPlaceholderImg.src = qrDataUrl; };
    const uploadAndSetUrl = async (file, onComplete) => { const formData = new FormData(); formData.append('image', file); try { const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData }); const result = await response.json(); if (result.success) { onComplete(result.data.url); } else { throw new Error(result.error?.message || 'Unknown error'); } } catch (error) { showNotification(translations[currentLang].uploadFailed + error.message, 'red', false); } };
    
    async function removeAndResetDesign() {
        if (currentUser && side) {
            const dbRef = ref(database, `cardTemplates/${currentUser.uid}/${side}`);
            try {
                await remove(dbRef);
                cardImageUrl = '';
                selectedFile = null;
                settings = JSON.parse(JSON.stringify(defaultSettings));
                
                DOMElements.activeCardSection.classList.add('hidden');
                DOMElements.uploaderInterface.classList.remove('hidden');
                DOMElements.imagePreview.classList.add('hidden');
                DOMElements.imagePreview.src = '';
                DOMElements.uploadButton.disabled = true;
                
                initializeControls();
                updatePlaceholders();
                showNotification('designRemoved', 'yellow');
            } catch (error) {
                showNotification(translations[currentLang].designSaveError + error.message, 'red', false);
            }
        }
    }

    const setupEventListeners = () => { ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => DOMElements.imageDropArea.addEventListener(e, evt => { evt.preventDefault(); evt.stopPropagation(); }, false)); ['dragenter', 'dragover'].forEach(e => DOMElements.imageDropArea.addEventListener(e, () => DOMElements.imageDropArea.classList.add('dragover'), false)); ['dragleave', 'drop'].forEach(e => DOMElements.imageDropArea.addEventListener(e, () => DOMElements.imageDropArea.classList.remove('dragover'), false)); DOMElements.imageDropArea.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]), false); DOMElements.imageUploader.addEventListener('change', e => handleFile(e.target.files[0])); DOMElements.uploadButton.addEventListener('click', async () => { if (!selectedFile) { showNotification('selectImageFirst', 'yellow'); return; } DOMElements.uploadButton.disabled = true; DOMElements.uploadSpinner.classList.remove('hidden'); await uploadAndSetUrl(selectedFile, url => { cardImageUrl = url; showNotification('uploadSuccess', 'green'); DOMElements.editorImagePreview.src = cardImageUrl; DOMElements.uploaderSection.classList.add('hidden'); DOMElements.editorSection.classList.remove('hidden'); DOMElements.uploadSpinner.classList.add('hidden'); initializeEditorInteractivity(); }); }); for (const key in controls) { const el = controls[key]; if (el && (el.type === 'checkbox' || el.type === 'range' || el.tagName === 'SELECT' || el.type === 'hidden')) el.addEventListener('input', updateSettings); } DOMElements.savePositionsButton.addEventListener('click', saveAndRedirect); controls.colorEyedropper.addEventListener('click', () => startEyedropper(controls.color)); controls.shadowColorEyedropper.addEventListener('click', () => startEyedropper(controls.shadowColor)); controls.strokeColorEyedropper.addEventListener('click', () => startEyedropper(controls.strokeColor)); controls.qrColorDarkEyedropper.addEventListener('click', () => startEyedropper(controls.qrColorDark)); controls.qrColorLightEyedropper.addEventListener('click', () => startEyedropper(controls.qrColorLight)); controls.qrLogo.addEventListener('change', e => {if (e.target.files[0]) uploadAndSetUrl(e.target.files[0], url => { settings.qr.logoUrl = url; updatePlaceholders(); })}); DOMElements.positioningArea.addEventListener('mousedown', (e) => { if (e.target === DOMElements.positioningArea) toggleSizeControls(null); }); DOMElements.sizeControls.addEventListener('mousedown', e => e.stopPropagation()); DOMElements.increaseSizeBtn.addEventListener('click', () => changeSize(1)); DOMElements.decreaseSizeBtn.addEventListener('click', () => changeSize(-1)); DOMElements.editCardButton.addEventListener('click', () => { DOMElements.uploaderSection.classList.add('hidden'); DOMElements.editorSection.classList.remove('hidden'); initializeEditorInteractivity(); }); DOMElements.removeCardButton.addEventListener('click', removeAndResetDesign); };
    function updateSettings(e) { const s = settings.name; const q = settings.qr; switch (e.target.id) { case 'font-color-picker': s.color = e.target.value; controls.colorDisplay.style.backgroundColor = s.color; break; case 'font-family-select': s.family = e.target.value; break; case 'font-size-slider': s.size = e.target.value; break; case 'font-rotation-slider': s.rotation = e.target.value; break; case 'font-bold-toggle': s.bold = e.target.checked; break; case 'font-italic-toggle': s.italic = e.target.checked; break; case 'shadow-toggle': s.shadow.enabled = e.target.checked; controls.shadowControls.classList.toggle('hidden'); break; case 'shadow-color-picker': s.shadow.color = e.target.value; controls.shadowColorDisplay.style.backgroundColor = s.shadow.color; break; case 'shadow-blur-slider': s.shadow.blur = e.target.value; break; case 'shadow-offset-x-slider': s.shadow.x = e.target.value; break; case 'shadow-offset-y-slider': s.shadow.y = e.target.value; break; case 'stroke-toggle': s.stroke.enabled = e.target.checked; controls.strokeControls.classList.toggle('hidden'); break; case 'stroke-color-picker': s.stroke.color = e.target.value; controls.strokeColorDisplay.style.backgroundColor = s.stroke.color; break; case 'stroke-width-slider': s.stroke.width = e.target.value; break; case 'qr-size-slider': q.size = e.target.value; break; case 'qr-color-dark-picker': q.colorDark = e.target.value; controls.qrColorDarkDisplay.style.backgroundColor = q.colorDark; break; case 'qr-color-light-picker': q.colorLight = e.target.value; controls.qrColorLightDisplay.style.backgroundColor = q.colorLight; break; } updatePlaceholders().then(() => { if(selectedPlaceholder) updateSizeControlsPosition(); }); }
    function initializeControls() { controls.color.value = settings.name.color; controls.colorDisplay.style.backgroundColor = settings.name.color; controls.family.value = settings.name.family; controls.size.value = settings.name.size; controls.rotation.value = settings.name.rotation; controls.bold.checked = settings.name.bold; controls.italic.checked = settings.name.italic; controls.shadow.checked = settings.name.shadow.enabled; controls.shadowControls.classList.toggle('hidden', !settings.name.shadow.enabled); controls.shadowColor.value = settings.name.shadow.color; controls.shadowColorDisplay.style.backgroundColor = settings.name.shadow.color; controls.shadowBlur.value = settings.name.shadow.blur; controls.shadowX.value = settings.name.shadow.x; controls.shadowY.value = settings.name.shadow.y; controls.stroke.checked = settings.name.stroke.enabled; controls.strokeControls.classList.toggle('hidden', !settings.name.stroke.enabled); controls.strokeColor.value = settings.name.stroke.color; controls.strokeColorDisplay.style.backgroundColor = settings.name.stroke.color; controls.strokeWidth.value = settings.name.stroke.width; controls.qrSize.value = settings.qr.size; controls.qrColorDark.value = settings.qr.colorDark; controls.qrColorDarkDisplay.style.backgroundColor = settings.qr.colorDark; controls.qrColorLight.value = settings.qr.colorLight; controls.qrColorLightDisplay.style.backgroundColor = settings.qr.colorLight; }
    const handleFile = (file) => { if (!file || !file.type.startsWith('image/')) return; selectedFile = file; const reader = new FileReader(); reader.onload = (event) => DOMElements.imagePreview.src = event.target.result; reader.readAsDataURL(selectedFile); DOMElements.imagePreview.classList.remove('hidden'); DOMElements.uploadButton.disabled = false; };
    
    const saveAndRedirect = () => {
        const areaRect = DOMElements.positioningArea.getBoundingClientRect();
        const nameRect = DOMElements.namePlaceholder.getBoundingClientRect();
        const qrRect = DOMElements.qrPlaceholder.getBoundingClientRect();

        const cardTemplate = {
            imageUrl: cardImageUrl,
            nameSettings: { 
                ...settings.name, 
                x: (nameRect.left - areaRect.left + nameRect.width / 2) / areaRect.width, 
                y: (nameRect.top - areaRect.top + nameRect.height / 2) / areaRect.height, 
                fontSize: settings.name.size / areaRect.height 
            },
            qrSettings: { 
                ...settings.qr, 
                x: (qrRect.left - areaRect.left + qrRect.width / 2) / areaRect.width, 
                y: (qrRect.top - areaRect.top + qrRect.height / 2) / areaRect.height, 
                size: settings.qr.size / areaRect.width
            }
        };
        
        if (currentUser && side) {
            const dbRef = ref(database, `cardTemplates/${currentUser.uid}/${side}`);
            set(dbRef, cardTemplate).then(() => {
                showNotification('designSaved', 'green');
                setTimeout(() => window.location.href = 'manager.html', 1500);
            }).catch(error => {
                showNotification(translations[currentLang].designSaveError + error.message, 'red', false);
            });
        }
    };

    async function loadInitialDesign() {
        setLanguage(currentLang);
        const generatedCardUrl = localStorage.getItem('generatedCardUrl');
        if (generatedCardUrl && currentUser && side) {
            localStorage.removeItem('generatedCardUrl');
            const newCardTemplate = { imageUrl: generatedCardUrl, nameSettings: defaultSettings.name, qrSettings: defaultSettings.qr };
            await set(ref(database, `cardTemplates/${currentUser.uid}/${side}`), newCardTemplate);
            showNotification('templateLoaded', 'green');
        }

        if (currentUser && side) {
            const dbRef = ref(database, `cardTemplates/${currentUser.uid}/${side}`);
            const snapshot = await get(dbRef);
            if (snapshot.exists()) {
                const savedTemplate = snapshot.val();
                cardImageUrl = savedTemplate.imageUrl;

                DOMElements.uploaderInterface.classList.add('hidden');
                DOMElements.activeCardSection.classList.remove('hidden');
                DOMElements.activeCardPreview.src = cardImageUrl;
                DOMElements.editorImagePreview.src = cardImageUrl;
                
                const img = DOMElements.editorImagePreview;
                await new Promise(resolve => { img.complete ? resolve() : img.onload = resolve; });

                const areaWidth = img.offsetWidth;
                const areaHeight = img.offsetHeight;

                const ns = savedTemplate.nameSettings;
                Object.assign(settings.name, ns);
                settings.name.size = ns.fontSize * areaHeight;

                const qs = savedTemplate.qrSettings;
                Object.assign(settings.qr, qs);
                settings.qr.size = qs.size * areaWidth;

                initializeControls();
                await updatePlaceholders();

                requestAnimationFrame(() => {
                    const nameWidth = DOMElements.namePlaceholder.offsetWidth;
                    const nameHeight = DOMElements.namePlaceholder.offsetHeight;
                    settings.name.x = (ns.x * areaWidth) - (nameWidth / 2);
                    settings.name.y = (ns.y * areaHeight) - (nameHeight / 2);
                    
                    const qrWidth = DOMElements.qrPlaceholder.offsetWidth;
                    settings.qr.x = (qs.x * areaWidth) - (qrWidth / 2);
                    settings.qr.y = (qs.y * areaHeight) - (qrWidth / 2);

                    updatePlaceholders();
                });
                
            } else {
                 initializeControls();
                 updatePlaceholders();
            }
        }
    }
    
    let eyeDropperCanvas = null, eyeDropperCtx = null, activeColorInput = null, isEyedropperActive = false;
    
    async function startEyedropper(targetInput) {
        if (isEyedropperActive) return;
        isEyedropperActive = true;
        activeColorInput = targetInput;
        DOMElements.eyedropperInstruction.classList.remove('hidden');

        const takeScreenshot = async () => {
            try {
                DOMElements.eyedropperOverlay.classList.remove('hidden');
                const canvas = await html2canvas(DOMElements.positioningArea, { useCORS: true, backgroundColor: null });
                eyeDropperCanvas = canvas;
                eyeDropperCtx = canvas.getContext('2d');
                DOMElements.eyedropperOverlay.addEventListener('mousemove', moveMagnifier);
                DOMElements.eyedropperOverlay.addEventListener('touchmove', moveMagnifier, { passive: false });
                DOMElements.eyedropperOverlay.addEventListener('click', pickColor);
                DOMElements.eyedropperOverlay.addEventListener('touchend', pickColor);
            } catch (error) {
                console.error("Eyedropper failed:", error);
                showNotification('eyedropperFail', 'red');
                stopEyedropper();
            }
        };

        DOMElements.positioningArea.scrollIntoView({ block: 'center', behavior: 'instant' });
        const image = DOMElements.editorImagePreview;

        requestAnimationFrame(() => {
            if (image.complete && image.naturalHeight !== 0) {
                takeScreenshot();
            } else {
                image.onload = takeScreenshot;
                image.onerror = () => {
                    console.error("Image failed to load for eyedropper.");
                    showNotification('eyedropperFail', 'red');
                    stopEyedropper();
                };
            }
        });
    }

    function moveMagnifier(e) { e.preventDefault(); const isTouchEvent = e.type.startsWith('touch'); const moveX = isTouchEvent ? e.touches[0].clientX : e.clientX; const moveY = isTouchEvent ? e.touches[0].clientY : e.clientY; DOMElements.magnifier.style.left = `${moveX}px`; DOMElements.magnifier.style.top = `${moveY}px`; const canvasRect = DOMElements.positioningArea.getBoundingClientRect(); const scale = eyeDropperCanvas.width / canvasRect.width; const x = (moveX - canvasRect.left) * scale; const y = (moveY - canvasRect.top) * scale; const zoomLevel = 3; DOMElements.magnifier.style.backgroundImage = `url(${eyeDropperCanvas.toDataURL()})`; DOMElements.magnifier.style.backgroundSize = `${eyeDropperCanvas.width * zoomLevel}px ${eyeDropperCanvas.height * zoomLevel}px`; DOMElements.magnifier.style.backgroundPosition = `-${x * zoomLevel - 50}px -${y * zoomLevel - 50}px`; }
    function pickColor(e) { const isTouchEvent = e.type.startsWith('touch'); const endX = isTouchEvent ? e.changedTouches[0].clientX : e.clientX; const endY = isTouchEvent ? e.changedTouches[0].clientY : e.clientY; const canvasRect = DOMElements.positioningArea.getBoundingClientRect(); const scale = eyeDropperCanvas.width / canvasRect.width; const x = Math.round((endX - canvasRect.left) * scale); const y = Math.round((endY - canvasRect.top) * scale); if (x >= 0 && y >= 0 && x < eyeDropperCanvas.width && y < eyeDropperCanvas.height) { const pixel = eyeDropperCtx.getImageData(x, y, 1, 1).data; const hex = `#${("000000" + ((pixel[0] << 16) | (pixel[1] << 8) | pixel[2]).toString(16)).slice(-6)}`; activeColorInput.value = hex; activeColorInput.dispatchEvent(new Event('input', { bubbles: true })); } stopEyedropper(); }
    function stopEyedropper() {
        DOMElements.eyedropperInstruction.classList.add('hidden');
        DOMElements.eyedropperOverlay.classList.add('hidden');
        DOMElements.eyedropperOverlay.removeEventListener('mousemove', moveMagnifier);
        DOMElements.eyedropperOverlay.removeEventListener('touchmove', moveMagnifier);
        DOMElements.eyedropperOverlay.removeEventListener('click', pickColor);
        DOMElements.eyedropperOverlay.removeEventListener('touchend', pickColor);
        eyeDropperCanvas = null;
        eyeDropperCtx = null;
        activeColorInput = null;
        isEyedropperActive = false;
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupEventListeners();
    });
</script>
</body>
</html>
