
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Template Designer</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Dancing+Script:wght@700&family=Roboto:wght@400;700;900&family=Plus+Jakarta+Sans:wght@400;500;700;800&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --font-main: 'Plus Jakarta Sans', sans-serif; }
  html[lang="ar"] { --font-main: 'Cairo', sans-serif; }
  body {
    font-family: var(--font-main);
    background-color: #0f172a;
    background-image:
      radial-gradient(at 20% 25%, hsla(212,80%,30%,0.3) 0px, transparent 50%),
      radial-gradient(at 80% 20%, hsla(280,75%,40%,0.3) 0px, transparent 50%),
      radial-gradient(at 50% 80%, hsla(320,70%,50%,0.2) 0px, transparent 50%);
  }
  .glass-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
  }
  .btn-primary {
    @apply font-bold py-3 px-6 rounded-lg text-white transition-all duration-300 ease-in-out;
    background: linear-gradient(90deg, #6366F1, #8B5CF6);
    box-shadow: 0 4px 15px 0 rgba(116, 79, 168, 0.5);
  }
  .btn-primary:hover:not(:disabled) {
    @apply shadow-2xl scale-105;
    box-shadow: 0 6px 20px 0 rgba(116, 79, 168, 0.65);
  }
  .btn-primary:disabled { background: #374151; box-shadow: none; transform: none; cursor: not-allowed; opacity: 0.6; }
  #positioning-area { touch-action: none; }
  .placeholder {
    position: absolute; cursor: move; user-select: none; top: 0; left: 0;
    display: flex; align-items-center; justify-content: center;
    border: 2px dashed rgba(255, 255, 255, 0.7);
  }
  #qr-placeholder-img, #location-qr-placeholder-img { max-width: 100%; height: auto; }
  #image-drop-area { border: 2px dashed rgba(255, 255, 255, 0.2); }
  #image-drop-area.dragover { border-color: #8B5CF6; background-color: rgba(139, 92, 246, 0.1); }
  input[type="range"]::-webkit-slider-thumb { @apply bg-indigo-400; }
  input[type="range"]::-moz-range-thumb { @apply bg-indigo-400; }
  .tab-button.active { @apply bg-indigo-500 text-white; }
</style>
</head>
<body class="text-gray-200" style="display: none;">

<header class="bg-slate-900/50 backdrop-blur-lg border-b border-white/10 sticky top-0 z-20">
  <div class="container mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-gray-100" data-lang-key="headerTitle">Template Designer</h1>
    <div class="flex items-center gap-4">
        <a href="index.html" class="text-sm font-semibold text-indigo-400 hover:text-indigo-300 transition-colors" data-lang-key="backToHub">&larr; Back to Hub</a>
        <button id="lang-switcher" class="font-bold text-sm border border-white/20 rounded-md px-3 py-1.5 hover:bg-white/10 transition-colors">AR</button>
        <button id="logout-button" class="font-bold text-sm bg-red-600/50 border border-red-500/30 text-red-300 rounded-md px-3 py-1.5 hover:bg-red-600/70 transition-colors" data-lang-key="logout">Logout</button>
    </div>
  </div>
</header>

<main class="container mx-auto p-4 md:p-8 flex flex-col items-center gap-8">
    <div class="w-full max-w-7xl glass-card p-6 rounded-2xl">
        <h2 class="text-xl font-semibold text-gray-100 mb-2" data-lang-key="templateSelectorTitle">1. Start with a Template (Optional)</h2>
        <p class="text-sm text-gray-400 mb-6" data-lang-key="templateSelectorDesc">Select a base design to get started quickly, or scroll down to upload your own custom design.</p>
        <div id="template-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <!-- Templates will be injected here by JS -->
        </div>
    </div>

    <div class="w-full max-w-7xl glass-card p-6 rounded-2xl">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-xl font-semibold text-gray-100" data-lang-key="customDesignTitle">2. Create Your Custom Design</h2>
                <p class="text-sm text-gray-400" data-lang-key="customDesignDesc">Design templates for the groom and bride sides. Start by selecting a tab.</p>
            </div>
            <div class="flex bg-slate-800 rounded-lg p-1">
                <button id="tab-groom" class="tab-button text-sm font-bold px-4 py-2 rounded-md transition-colors" data-template-key="groom" data-lang-key="groomSide">Groom's Side</button>
                <button id="tab-bride" class="tab-button text-sm font-bold px-4 py-2 rounded-md transition-colors" data-template-key="bride" data-lang-key="brideSide">Bride's Side</button>
            </div>
        </div>
    
        <div id="uploader-section">
          <p class="text-sm text-gray-400 mb-6" data-lang-key="uploadDesc">Drag & drop your image or GIF file, or click to select one.</p>
          <div id="image-drop-area" class="relative flex flex-col items-center justify-center w-full h-64 rounded-lg cursor-pointer bg-white/5 hover:bg-white/10 transition-colors">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                  <svg class="w-10 h-10 mb-4 text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/></svg>
                  <p class="mb-2 text-sm text-gray-400"><span class="font-semibold" data-lang-key="clickToUpload">Click to upload</span><span data-lang-key="orDragDrop"> or drag and drop</span></p>
                  <p class="text-xs text-gray-500">PNG, JPG or GIF</p>
              </div>
              <input type="file" id="imageUploader" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
          </div>
          <img id="imagePreview" class="mt-4 rounded-md hidden border-2 border-white/10 w-full" alt="Image Preview"/>
          <button id="uploadButton" class="mt-6 w-full btn-primary" data-lang-key="uploadBtn" disabled>Upload & Continue to Editor</button>
          <div id="uploadSpinner" class="hidden mt-4 text-center"><div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] text-indigo-400" role="status"></div><p class="text-sm text-gray-400 mt-2" data-lang-key="uploading">Uploading to secure storage...</p></div>
        </div>
    </div>

    <div id="editor-section" class="w-full max-w-7xl hidden">
      <div class="glass-card p-6 rounded-2xl">
        <h2 class="text-xl font-semibold text-gray-100 mb-2" data-lang-key="editorTitle">3. Position & Style Details</h2>
        <p class="text-sm text-gray-400 mb-6" data-lang-key="editorDesc">Drag the placeholders to position them. A static image will be generated from GIFs. Use controls to customize.</p>
        <div class="flex flex-col lg:flex-row gap-6">
          <div id="positioning-area" class="flex-grow relative inline-block select-none overflow-hidden rounded-lg border-2 border-white/10 bg-black">
            <img id="editor-image-preview" src="" class="max-w-full h-auto block opacity-80" alt="Invitation Preview"/>
            <div id="name-placeholder" class="placeholder p-2" style="color: white;" data-lang-key="guestName">Guest Name</div>
            <div id="qr-placeholder" class="placeholder"><img id="qr-placeholder-img" src="" alt="Check-in QR Preview"/></div>
            <div id="location-qr-placeholder" class="placeholder"><img id="location-qr-placeholder-img" src="" alt="Location QR Preview"/></div>
          </div>
          <div class="lg:w-80 flex-shrink-0 space-y-4">
              <div class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="elementsTitle">Optional Elements</h3>
                  <div class="space-y-3">
                    <label class="flex items-center"><input type="checkbox" id="name-enabled-toggle" class="h-4 w-4 rounded bg-slate-700 border-slate-500"><span class="ms-2 text-sm text-gray-300" data-lang-key="includeGuestName">Include Guest Name</span></label>
                    <label class="flex items-center"><input type="checkbox" id="location-enabled-toggle" class="h-4 w-4 rounded bg-slate-700 border-slate-500"><span class="ms-2 text-sm text-gray-300" data-lang-key="includeLocation">Include Event Location</span></label>
                  </div>
                  <div id="location-controls" class="hidden mt-4 space-y-2">
                    <input type="url" id="location-url-input" placeholder="Paste Google Maps URL here" class="w-full p-2 bg-slate-800 border border-slate-600 rounded-lg text-gray-200 text-sm">
                    <button id="generate-location-qr" class="w-full text-sm font-bold py-2 px-4 rounded-lg text-white bg-teal-600 hover:bg-teal-500 transition-colors" data-lang-key="generateLocationQR">Generate Location QR</button>
                  </div>
              </div>
              <div class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="nameStyleTitle">Guest Name Style</h3>
                  <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="fontColor">Font Color</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="font-color-picker" class="p-1 h-10 w-full bg-slate-800 border border-slate-600 cursor-pointer rounded-lg">
                            <button id="eyedropper-font" class="p-2 bg-slate-700 rounded-lg hover:bg-slate-600"></button>
                        </div>
                      </div>
                      <div>
                          <label for="font-family-select" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="fontFamily">Font Family</label>
                          <select id="font-family-select" class="w-full p-2 bg-slate-800 border border-slate-600 rounded-lg text-gray-200 text-sm">
                              <option style="font-family: 'Amiri', serif;" value="'Amiri', serif">Amiri</option>
                              <option style="font-family: 'Dancing Script', cursive;" value="'Dancing Script', cursive">Dancing Script</option>
                              <option style="font-family: 'Roboto', sans-serif;" value="'Roboto', sans-serif">Roboto</option>
                              <option style="font-family: 'Plus Jakarta Sans', sans-serif;" value="'Plus Jakarta Sans', sans-serif">Plus Jakarta Sans</option>
                              <option style="font-family: 'Cairo', sans-serif;" value="'Cairo', sans-serif">Cairo</option>
                          </select>
                      </div>
                      <div>
                        <label class="block text-sm font-medium text-gray-400" data-lang-key="fontSize">Font Size</label>
                        <input id="font-size-slider" type="range" min="8" max="100" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer">
                      </div>
                      <div class="pt-1">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="font-weight-toggle" class="h-4 w-4 rounded bg-slate-700 border-slate-500 text-indigo-500 focus:ring-indigo-500">
                            <span class="ms-2 text-sm text-gray-300" data-lang-key="fontWeightBold">Bold</span>
                        </label>
                      </div>
                  </div>
              </div>
              <div class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="qrStyleTitle">Check-in QR Style</h3>
                  <div class="space-y-4">
                      <div class="grid grid-cols-2 gap-2">
                        <div><label class="text-sm text-gray-400">Modules</label><div class="flex items-center gap-2"><input type="color" id="qr-color-dark-picker" class="p-1 h-10 w-full bg-slate-800 border border-slate-600 rounded"><button id="eyedropper-qr-dark" class="p-2 bg-slate-700 rounded-lg hover:bg-slate-600"></button></div></div>
                        <div><label class="text-sm text-gray-400">Background</label><div class="flex items-center gap-2"><input type="color" id="qr-color-light-picker" class="p-1 h-10 w-full bg-slate-800 border border-slate-600 rounded"><button id="eyedropper-qr-light" class="p-2 bg-slate-700 rounded-lg hover:bg-slate-600"></button></div></div>
                      </div>
                      <div><label class="block text-sm font-medium text-gray-400" data-lang-key="qrSize">Size</label><input id="qr-size-slider" type="range" min="40" max="400" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer"></div>
                  </div>
              </div>
              <div class="bg-slate-800/50 p-4 rounded-lg">
                  <h3 class="font-bold text-lg text-gray-100 border-b border-white/10 mb-3 pb-2" data-lang-key="locationQrStyleTitle">Location QR Style</h3>
                  <div><label class="block text-sm font-medium text-gray-400" data-lang-key="qrSize">Size</label><input id="location-qr-size-slider" type="range" min="40" max="400" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer"></div>
              </div>
          </div>
        </div>
        <button id="save-positions-button" class="mt-8 w-full btn-primary" data-lang-key="saveBtn">Save Template & Continue &rarr;</button>
      </div>
    </div>
</main>
<div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-x-[120%] transition-transform duration-500 ease-in-out"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    import QRCode from 'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm';

    const firebaseConfig = { apiKey: "AIzaSyCuZVUBIA0oDQuPzRUQbMJCJZK32zmVaVQ", authDomain: "final-draft-8f39d.firebaseapp.com", databaseURL: "https://final-draft-8f39d-default-rtdb.firebaseio.com", projectId: "final-draft-8f39d", storageBucket: "final-draft-8f39d.appspot.com", messagingSenderId: "994437210054", appId: "1:994437210054:web:628c741b81ccf741175cc7" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) { document.body.style.display = 'block'; } else { window.location.href = 'login.html'; }
    });
    document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
    
    const translations = {
        en: { headerTitle: "Template Designer", backToHub: "← Back to Hub", templateSelectorTitle: "1. Start with a Template (Optional)", templateSelectorDesc: "Select a base design to get started quickly, or scroll down to upload your own custom design.", customDesignTitle: "2. Create Your Custom Design", customDesignDesc: "Design templates for the groom and bride sides. Start by selecting a tab.", groomSide: "Groom's Side", brideSide: "Bride's Side", uploadDesc: "Drag & drop your image or GIF file, or click to select one.", clickToUpload: "Click to upload", orDragDrop: " or drag and drop", uploadBtn: "Upload & Continue to Editor", uploading: "Uploading to secure storage...", editorTitle: "3. Position & Style Details", editorDesc: "Drag the placeholders to position them. A static image will be generated from GIFs. Use controls to customize.", guestName: "Guest Name", elementsTitle: "Optional Elements", includeGuestName: "Include Guest Name", includeLocation: "Include Event Location", generateLocationQR: "Generate Location QR", nameStyleTitle: "Guest Name Style", fontColor: "Font Color", fontSize: "Font Size", fontFamily: "Font Family", fontWeightBold: "Bold", qrStyleTitle: "Check-in QR Style", qrSize: "Size", locationQrStyleTitle: "Location QR Style", saveBtn: "Save Template & Continue →", selectImageFirst: "Please select an image first", uploadSuccess: "Upload successful!", uploadFailed: "Image upload failed: ", designSaved: "Template saved! You can now manage guests or design the other template.", invalidLocationUrl: "Please enter a valid URL for the location.", locationQrGenerated: "Location QR code generated.", noLocationUrl: "Please provide a location URL first.", eyedropperNotSupported: "Eyedropper not supported in your browser.", logout: "Logout" },
        ar: { headerTitle: "مصمم القوالب", backToHub: "→ العودة للمركز", templateSelectorTitle: "١. ابدأ بقالب جاهز (اختياري)", templateSelectorDesc: "اختر تصميمًا أساسيًا للبدء بسرعة ، أو قم بالتمرير لأسفل لتحميل تصميمك المخصص.", customDesignTitle: "٢. أنشئ تصميمك المخصص", customDesignDesc: "صمم قوالب لجهة العريس وجهة العروس. ابدأ باختيار علامة تبويب.", groomSide: "جهة العريس", brideSide: "جهة العروس", uploadDesc: "اسحب وأفلت ملف الصورة أو GIF، أو انقر للاختيار.", clickToUpload: "انقر للرفع", orDragDrop: " أو اسحب وأفلت", uploadBtn: "رفع ومتابعة إلى المحرر", uploading: "جاري الرفع إلى التخزين الآمن...", editorTitle: "٣. تحديد أماكن وتنسيق التفاصيل", editorDesc: "اسحب العناصر لتحديد أماكنها. سيتم إنشاء صورة ثابتة من ملفات GIF. استخدم عناصر التحكم للتخصيص.", guestName: "اسم الضيف", elementsTitle: "عناصر اختيارية", includeGuestName: "إضافة اسم الضيف", includeLocation: "إضافة موقع المناسبة", generateLocationQR: "إنشاء QR للموقع", nameStyleTitle: "تنسيق اسم الضيف", fontColor: "لون الخط", fontSize: "حجم الخط", fontFamily: "نوع الخط", fontWeightBold: "عريض", qrStyleTitle: "تنسيق QR تسجيل الدخول", qrSize: "الحجم", locationQrStyleTitle: "تنسيق QR الموقع", saveBtn: "حفظ القالب والمتابعة ←", selectImageFirst: "الرجاء اختيار صورة أولاً", uploadSuccess: "تم الرفع بنجاح!", uploadFailed: "فشل رفع الصورة: ", designSaved: "تم حفظ القالب! يمكنك الآن إدارة الضيوف أو تصميم القالب الآخر.", invalidLocationUrl: "الرجاء إدخال رابط صحيح للموقع.", locationQrGenerated: "تم إنشاء رمز QR للموقع.", noLocationUrl: "يرجى تقديم رابط الموقع أولاً.", eyedropperNotSupported: "أداة انتقاء الألوان غير مدعومة في متصفحك.", logout: "تسجيل الخروج" }
    };
    
    // --- Language Handler ---
    let currentLang = localStorage.getItem('language') || 'en';
    const setLanguage = (lang) => { localStorage.setItem('language', lang); currentLang = lang; document.documentElement.lang = lang; document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr'; document.getElementById('lang-switcher').textContent = lang === 'ar' ? 'EN' : 'AR'; document.querySelectorAll('[data-lang-key]').forEach(el => { const key = el.getAttribute('data-lang-key'); if (translations[lang][key]) el.textContent = translations[lang][key]; }); document.title = translations[lang].headerTitle; };
    document.getElementById('lang-switcher').addEventListener('click', () => setLanguage(currentLang === 'en' ? 'ar' : 'en'));
    document.addEventListener('DOMContentLoaded', () => setLanguage(currentLang));

    // --- Main App Logic ---
    const IMGBB_API_KEY = '97c60166127ae9258012f463e09b1e2d';
    let activeTemplateKey = 'groom'; // 'groom' or 'bride'
    let selectedFile = null;

    const DOMElements = {
        uploaderSection: document.getElementById('uploader-section'),
        editorSection: document.getElementById('editor-section'),
        imageUploader: document.getElementById('imageUploader'),
        imagePreview: document.getElementById('imagePreview'),
        uploadButton: document.getElementById('uploadButton'),
        uploadSpinner: document.getElementById('uploadSpinner'),
        imageDropArea: document.getElementById('image-drop-area'),
        editorImagePreview: document.getElementById('editor-image-preview'),
        positioningArea: document.getElementById('positioning-area'),
        namePlaceholder: document.getElementById('name-placeholder'),
        qrPlaceholder: document.getElementById('qr-placeholder'),
        locationQrPlaceholder: document.getElementById('location-qr-placeholder'),
        savePositionsButton: document.getElementById('save-positions-button'),
        notification: document.getElementById('notification'),
        tabGroom: document.getElementById('tab-groom'),
        tabBride: document.getElementById('tab-bride'),
    };

    const controls = {
        nameEnabled: document.getElementById('name-enabled-toggle'),
        fontColor: document.getElementById('font-color-picker'),
        fontSize: document.getElementById('font-size-slider'),
        fontFamily: document.getElementById('font-family-select'),
        fontWeight: document.getElementById('font-weight-toggle'),
        qrSize: document.getElementById('qr-size-slider'),
        qrColorDark: document.getElementById('qr-color-dark-picker'),
        qrColorLight: document.getElementById('qr-color-light-picker'),
        locationEnabled: document.getElementById('location-enabled-toggle'),
        locationControls: document.getElementById('location-controls'),
        locationUrlInput: document.getElementById('location-url-input'),
        generateLocationQr: document.getElementById('generate-location-qr'),
        locationQrSize: document.getElementById('location-qr-size-slider'),
    };

    let settings = {};
    const defaultSettings = {
        imageUrl: '',
        name: { enabled: true, x: 0.5, y: 0.2, color: '#FFFFFF', size: 40, family: "'Plus Jakarta Sans', sans-serif", weight: 'bold' },
        qr: { x: 0.5, y: 0.8, size: 100, colorDark: '#000000', colorLight: '#FFFFFF' },
        locationQr: { enabled: false, x: 0.5, y: 0.5, size: 80, url: '' }
    };
    
    function loadSettings() {
        const savedSettings = localStorage.getItem(`cardTemplate_${activeTemplateKey}`);
        settings = savedSettings ? JSON.parse(savedSettings) : JSON.parse(JSON.stringify(defaultSettings));
        updateAllControls();
        updatePlaceholders();
    }
    
    function updateAllControls() {
        controls.nameEnabled.checked = settings.name.enabled;
        controls.fontColor.value = settings.name.color;
        controls.fontSize.value = settings.name.size;
        controls.fontFamily.value = settings.name.family;
        controls.fontWeight.checked = settings.name.weight === 'bold';
        controls.qrSize.value = settings.qr.size;
        controls.qrColorDark.value = settings.qr.colorDark;
        controls.qrColorLight.value = settings.qr.colorLight;
        controls.locationEnabled.checked = settings.locationQr.enabled;
        controls.locationUrlInput.value = settings.locationQr.url;
        controls.locationQrSize.value = settings.locationQr.size;
        
        DOMElements.namePlaceholder.style.display = settings.name.enabled ? 'flex' : 'none';
        DOMElements.locationQrPlaceholder.style.display = settings.locationQr.enabled ? 'flex' : 'none';
        controls.locationControls.style.display = settings.locationQr.enabled ? 'block' : 'none';
    }

    const showNotification = (messageKey, type = 'green') => {
        const message = translations[currentLang][messageKey] || messageKey;
        const colors = { green: 'bg-green-500', red: 'bg-red-500', yellow: 'bg-yellow-500' };
        DOMElements.notification.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl transition-transform duration-500 ease-in-out ${colors[type] || 'bg-gray-500'} transform translate-x-[120%]`;
        DOMElements.notification.textContent = message;
        requestAnimationFrame(() => DOMElements.notification.style.transform = 'translateX(0)');
        setTimeout(() => DOMElements.notification.style.transform = 'translateX(120%)', 3000);
    };

    const updatePlaceholders = async () => {
        const updateElement = (el, opts) => {
            const areaRect = DOMElements.positioningArea.getBoundingClientRect();
            if(!areaRect.width || !areaRect.height) return;
            el.style.width = `${opts.size}px`;
            el.style.height = (el.id === 'name-placeholder') ? 'auto' : `${opts.size}px`;
            el.style.fontSize = `${opts.size}px`;
            if (opts.color) el.style.color = opts.color;
            if (opts.family) el.style.fontFamily = opts.family;
            if (opts.weight) el.style.fontWeight = opts.weight;
            const x = opts.x * areaRect.width - (el.offsetWidth / 2);
            const y = opts.y * areaRect.height - (el.offsetHeight / 2);
            el.style.transform = `translate3d(${x}px, ${y}px, 0)`;
        };
        updateElement(DOMElements.namePlaceholder, settings.name);
        updateElement(DOMElements.qrPlaceholder, settings.qr);
        updateElement(DOMElements.locationQrPlaceholder, settings.locationQr);

        const qrDataUrl = await QRCode.toDataURL('PREVIEW_CHECK-IN', { width: 400, margin: 1, errorCorrectionLevel: 'H', color: { dark: settings.qr.colorDark, light: settings.qr.colorLight } });
        DOMElements.qrPlaceholder.querySelector('img').src = qrDataUrl;
        
        if (settings.locationQr.enabled && settings.locationQr.url) {
            const locQrDataUrl = await QRCode.toDataURL(settings.locationQr.url, { width: 400, margin: 1, errorCorrectionLevel: 'M' });
            DOMElements.locationQrPlaceholder.querySelector('img').src = locQrDataUrl;
        }
    };

    function makeDraggable(element, settingObj) {
        let active = false, initialX, initialY, startX, startY;
        const dragStart = (e) => {
            if (e.target === element || element.contains(e.target)) {
                active = true;
                element.style.zIndex = 10;
                const event = e.type === 'touchstart' ? e.touches[0] : e;
                const areaRect = DOMElements.positioningArea.getBoundingClientRect();
                const currentX = settingObj.x * areaRect.width - element.offsetWidth / 2;
                const currentY = settingObj.y * areaRect.height - element.offsetHeight / 2;
                initialX = event.clientX - currentX;
                initialY = event.clientY - currentY;
            }
        };
        const dragEnd = () => { active = false; element.style.zIndex = 1; };
        const drag = (e) => {
            if (active) {
                e.preventDefault();
                const event = e.type === 'touchmove' ? e.touches[0] : e;
                const areaRect = DOMElements.positioningArea.getBoundingClientRect();
                let currentX = event.clientX - initialX;
                let currentY = event.clientY - initialY;

                currentX = Math.max(0, Math.min(currentX, areaRect.width - element.offsetWidth));
                currentY = Math.max(0, Math.min(currentY, areaRect.height - element.offsetHeight));
                
                settingObj.x = (currentX + element.offsetWidth / 2) / areaRect.width;
                settingObj.y = (currentY + element.offsetHeight / 2) / areaRect.height;
                updatePlaceholders();
            }
        };
        ['touchstart', 'mousedown'].forEach(evt => DOMElements.positioningArea.addEventListener(evt, dragStart, false));
        ['touchend', 'mouseup', 'mouseleave'].forEach(evt => document.addEventListener(evt, dragEnd, false));
        ['touchmove', 'mousemove'].forEach(evt => document.addEventListener(evt, drag, false));
    }
    
    function updateSettings(e) {
        const s = settings;
        switch (e.target.id) {
            case 'name-enabled-toggle': s.name.enabled = e.target.checked; DOMElements.namePlaceholder.style.display = s.name.enabled ? 'flex' : 'none'; break;
            case 'font-color-picker': s.name.color = e.target.value; break;
            case 'font-size-slider': s.name.size = e.target.value; break;
            case 'font-family-select': s.name.family = e.target.value; break;
            case 'font-weight-toggle': s.name.weight = e.target.checked ? 'bold' : 'normal'; break;
            case 'qr-color-dark-picker': s.qr.colorDark = e.target.value; break;
            case 'qr-color-light-picker': s.qr.colorLight = e.target.value; break;
            case 'qr-size-slider': s.qr.size = e.target.value; break;
            case 'location-enabled-toggle': s.locationQr.enabled = e.target.checked; DOMElements.locationQrPlaceholder.style.display = s.locationQr.enabled ? 'flex' : 'none'; controls.locationControls.style.display = s.locationQr.enabled ? 'block' : 'none'; break;
            case 'location-url-input': s.locationQr.url = e.target.value; break;
            case 'location-qr-size-slider': s.locationQr.size = e.target.value; break;
        }
        updatePlaceholders();
    }

    const handleFile = (file) => {
        if (!file || !file.type.startsWith('image/')) return;
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (event) => DOMElements.imagePreview.src = event.target.result;
        reader.readAsDataURL(selectedFile);
        DOMElements.imagePreview.classList.remove('hidden');
        DOMElements.uploadButton.disabled = false;
    };
    
    const uploadImage = async (file) => {
        const formData = new FormData();
        formData.append('image', file);
        try {
            DOMElements.uploadButton.disabled = true;
            DOMElements.uploadSpinner.classList.remove('hidden');
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) return result.data.url;
            throw new Error(result.error?.message || 'Unknown error');
        } catch (error) {
            showNotification(`${translations[currentLang].uploadFailed} ${error.message}`, 'red');
            return null;
        } finally {
            DOMElements.uploadButton.disabled = false;
            DOMElements.uploadSpinner.classList.add('hidden');
        }
    };
    
    function switchTemplateTab(key) {
        activeTemplateKey = key;
        DOMElements.tabGroom.classList.toggle('active', key === 'groom');
        DOMElements.tabBride.classList.toggle('active', key === 'bride');
        
        // Reset uploader and hide editor
        DOMElements.editorSection.classList.add('hidden');
        DOMElements.uploaderSection.classList.remove('hidden');
        DOMElements.imagePreview.classList.add('hidden');
        DOMElements.imagePreview.src = '';
        DOMElements.imageUploader.value = '';
        selectedFile = null;
        DOMElements.uploadButton.disabled = true;
        
        loadSettings();
    }

    function setupEventListeners() {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => DOMElements.imageDropArea.addEventListener(e, evt => { evt.preventDefault(); evt.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(e => DOMElements.imageDropArea.addEventListener(e, () => DOMElements.imageDropArea.classList.add('dragover')));
        ['dragleave', 'drop'].forEach(e => DOMElements.imageDropArea.addEventListener(e, () => DOMElements.imageDropArea.classList.remove('dragover')));
        DOMElements.imageDropArea.addEventListener('drop', e => handleFile(e.dataTransfer.files[0]));
        DOMElements.imageUploader.addEventListener('change', e => handleFile(e.target.files[0]));
        
        DOMElements.uploadButton.addEventListener('click', async () => {
            if (!selectedFile) { showNotification('selectImageFirst', 'yellow'); return; }
            const imageUrl = await uploadImage(selectedFile);
            if(imageUrl) {
                settings.imageUrl = imageUrl;
                showNotification('uploadSuccess', 'green');
                DOMElements.editorImagePreview.src = imageUrl;
                DOMElements.uploaderSection.classList.add('hidden');
                DOMElements.editorSection.classList.remove('hidden');
                setTimeout(updatePlaceholders, 100); // Allow image to render
            }
        });

        Object.values(controls).forEach(el => {
            const eventType = ['checkbox', 'range'].includes(el.type) ? 'input' : 'change';
            el.addEventListener(eventType, updateSettings);
            if (el.type === 'color') el.addEventListener('input', updateSettings);
        });

        DOMElements.savePositionsButton.addEventListener('click', () => {
             localStorage.setItem(`cardTemplate_${activeTemplateKey}`, JSON.stringify(settings));
             showNotification('designSaved', 'green');
             setTimeout(() => window.location.href = 'manager.html', 1500);
        });
        
        DOMElements.tabGroom.addEventListener('click', () => switchTemplateTab('groom'));
        DOMElements.tabBride.addEventListener('click', () => switchTemplateTab('bride'));

        controls.generateLocationQr.addEventListener('click', () => {
            if (!settings.locationQr.url) { showNotification('noLocationUrl', 'yellow'); return; }
            try { new URL(settings.locationQr.url); updatePlaceholders(); showNotification('locationQrGenerated', 'green'); }
            catch (e) { showNotification('invalidLocationUrl', 'red'); }
        });

        // Eyedropper functionality
        const eyedropperIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75L14.25 12m0 0l2.25 2.25M14.25 12l2.25-2.25M14.25 12L12 14.25m-2.58 4.92l-6.375-6.375a1.125 1.125 0 010-1.59L9.42 4.83c.211-.211.498-.33.796-.33H19.5a2.25 2.25 0 012.25 2.25v10.5a2.25 2.25 0 01-2.25 2.25h-9.284c-.298 0-.585-.119-.796-.33z" /></svg>`;
        const eyedropperButtons = [
            { id: 'eyedropper-font', input: controls.fontColor },
            { id: 'eyedropper-qr-dark', input: controls.qrColorDark },
            { id: 'eyedropper-qr-light', input: controls.qrColorLight }
        ];

        eyedropperButtons.forEach(({ id, input }) => {
            const button = document.getElementById(id);
            button.innerHTML = eyedropperIcon;
            if ('EyeDropper' in window) {
                button.addEventListener('click', async () => {
                    DOMElements.positioningArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // A small delay to allow for scroll animation before eyedropper opens
                    await new Promise(resolve => setTimeout(resolve, 300));
                    try {
                        const eyeDropper = new EyeDropper();
                        const result = await eyeDropper.open();
                        input.value = result.sRGBHex;
                        input.dispatchEvent(new Event('input')); // Trigger update
                    } catch (e) { console.info('EyeDropper cancelled'); }
                });
            } else {
                button.disabled = true;
                button.style.cursor = 'not-allowed';
                button.style.opacity = '0.5';
                button.title = translations[currentLang].eyedropperNotSupported;
            }
        });
    }
    
    // --- Template Selector ---
    const templates = [
        { name: 'Classic Gold', url: 'https://i.ibb.co/hK7yYjR/template1.jpg' },
        { name: 'Modern Floral', url: 'https://i.ibb.co/k552zJj/template2.jpg' },
        { name: 'Elegant Blue', url: 'https://i.ibb.co/yY1kGk5/template3.jpg' },
        { name: 'Simple Greenery', url: 'https://i.ibb.co/M7bSTsQ/template4.jpg' }
    ];

    function initializeTemplates() {
        const grid = document.getElementById('template-grid');
        templates.forEach(template => {
            const templateEl = document.createElement('div');
            templateEl.className = 'cursor-pointer group';
            templateEl.innerHTML = `
                <img src="${template.url}" alt="${template.name}" class="w-full h-auto rounded-lg border-2 border-transparent group-hover:border-indigo-400 transition-all duration-300 group-hover:scale-105">
                <p class="text-center text-sm mt-2 font-semibold text-gray-300">${template.name}</p>
            `;
            templateEl.addEventListener('click', async () => {
                const response = await fetch(template.url);
                const blob = await response.blob();
                selectedFile = new File([blob], `${template.name.replace(' ','_')}.jpg`, { type: blob.type });
                handleFile(selectedFile);
                DOMElements.uploadButton.click();
            });
            grid.appendChild(templateEl);
        });
    }

    // --- Initialization ---
    initializeTemplates();
    setupEventListeners();
    makeDraggable(DOMElements.namePlaceholder, settings.name);
    makeDraggable(DOMElements.qrPlaceholder, settings.qr);
    makeDraggable(DOMElements.locationQrPlaceholder, settings.locationQr);
    switchTemplateTab('groom'); // Start on groom tab
</script>
</body>
</html>
